<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‡ªå¾‹åŠ©æ‰‹</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Arial, sans-serif;
        background: white;
        min-height: 100vh;
        overflow: auto; /* å…è®¸æ‰‹æœºç«¯ä¸Šä¸‹æ»‘åŠ¨ */
      }

      /* ä¸»é¢˜è‰²å˜é‡ */
      :root {
        --primary-color: #4caf50;
        --primary-hover: #45a049;
        --background-color: white;
        --content-opacity: 0.95;
        --text-box-opacity: 0.9;
        --blur-amount: 10px;
      }

      /* åŠ¨ç”»æ•ˆæœ */
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(-10px);
        }
        10% {
          opacity: 1;
          transform: translateY(0);
        }
        90% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* é¡¶éƒ¨ä¿¡æ¯æ  */
      .top-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
        backdrop-filter: blur(var(--blur-amount));
      }

      /* èƒŒæ™¯å›¾ç‰‡æ ·å¼ */
      body.has-background {
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
      }

      .main-app {
        background: rgba(255, 255, 255, var(--content-opacity));
        backdrop-filter: blur(var(--blur-amount));
        transition: background 0.3s ease, opacity 0.3s ease,
          backdrop-filter 0.3s ease;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.9rem;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
      }

      /* å…¬å‘Šå›¾æ ‡æ ·å¼ */
      .announcement-icon {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }
      
      .announcement-icon:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      
      /* å¯é€‰ï¼šæ·»åŠ é€šçŸ¥çº¢ç‚¹æç¤º */
      .announcement-icon.has-notification {
        position: relative;
      }
      
      .announcement-icon.has-notification::after {
        content: '';
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        background-color: #ff4444;
        border-radius: 50%;
        border: 1px solid white;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        color: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        overflow: hidden;
        position: relative;
      }

      .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .username {
        font-weight: bold;
        font-size: 0.9rem;
      }

      .avatar-upload {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        font-size: 0.8rem;
        text-align: center;
        line-height: 40px;
        border-radius: 50%;
      }

      .user-avatar:hover .avatar-upload {
        display: block;
      }

      /* æ¬¢è¿ç•Œé¢ */
      .welcome-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.8s ease-in;
      }

      .welcome-screen h1 {
        font-size: 3rem;
        color: #333;
        font-weight: 300;
      }

      /* ç™»å½•/æ³¨å†Œç•Œé¢ */
      .login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999;
        opacity: 0;
        transition: opacity 0.8s ease-in;
      }

      .login-container {
        width: 100%;
        max-width: 400px;
        padding: 2rem;
        text-align: center;
        background: rgba(255, 255, 255, var(--text-box-opacity));
        border-radius: 15px;
        backdrop-filter: blur(var(--blur-amount));
      }

      .login-container h2 {
        margin-bottom: 2rem;
        color: #333;
        font-weight: 400;
      }

      .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #555;
        font-size: 0.9rem;
      }

      .form-group input {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
      }

      .form-group input:focus {
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 0.8rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .btn:hover {
        background: var(--primary-hover);
      }

      .toggle-link {
        margin-top: 1rem;
        color: #666;
        font-size: 0.9rem;
      }

      .toggle-link a {
        color: #667eea;
        text-decoration: none;
        margin-left: 0.5rem;
      }

      /* ä¸»ç•Œé¢ */
      .main-app {
        display: none;
        height: 100vh;
        background: #f5f5f5;
        position: relative;
        opacity: 0;
        transition: opacity 0.8s ease-in;
        padding-top: 60px;
      }

      .content-area {
        height: calc(100vh - 60px - 70px);
        overflow-y: auto;
        padding: 1rem;
      }

      /* å¯¼èˆªæ  */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, var(--text-box-opacity));
        backdrop-filter: blur(var(--blur-amount));
        display: flex;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #666;
      }

      .nav-item.active {
        color: var(--primary-color);
      }

      .nav-item i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 0.2rem;
      }

      /* ä»£åŠç•Œé¢ */
      .todo-section,
      .tools-section,
      .shop-section,
      .profile-section {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-out;
      }

      .todo-section.active,
      .tools-section.active,
      .shop-section.active,
      .profile-section.active {
        display: block;
        opacity: 1;
      }

      .todo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .todo-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        flex: 1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
      }

      .add-todo-btn {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 100;
        transition: opacity 0.5s ease, visibility 0.5s ease, transform 0.3s ease,
          background-color 0.3s ease;
      }

      .add-todo-btn:hover {
        background: var(--primary-hover);
        transform: scale(1.1);
      }

      .todo-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .todo-item {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
        backdrop-filter: blur(var(--blur-amount));
      }

      .todo-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .todo-content {
        flex: 1;
      }

      .todo-title {
        font-weight: bold;
        margin-bottom: 0.2rem;
      }

      .todo-time {
        font-size: 0.8rem;
        color: #666;
      }

      .todo-priority {
        padding: 0.2rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        color: white;
      }

      .priority-high {
        background: #ff4757;
      }
      .priority-medium {
        background: #ffa502;
      }
      .priority-low {
        background: #2ed573;
      }

      /* æˆ‘çš„ç•Œé¢ */
      .profile-header {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .profile-avatar {
        width: 80px;
        height: 80px;
        background: #667eea;
        border-radius: 50%;
        margin: 0 auto 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
      }

      .profile-info {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(238, 238, 238, var(--text-box-opacity));
      }

      .info-item:last-child {
        border-bottom: none;
      }

      /* å¼¹çª— */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1001;
      }

      .modal-content {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        backdrop-filter: blur(var(--blur-amount));
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
      }

      .remember-me {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 1rem;
      }

      .remember-me input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .remember-me label {
        margin-bottom: 0;
        cursor: pointer;
        color: #666;
        user-select: none;
      }

      /* å·¥å…·æ  */
      .tools-section,
      .shop-section {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      /* è‡ªå¾‹æ—¥å†æ ·å¼ */
      .calendar-container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, var(--text-box-opacity));
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .calendar-header h3 {
        color: #333;
        font-weight: 400;
        margin: 0;
      }

      .calendar-nav {
        display: flex;
        gap: 0.5rem;
      }

      .calendar-nav button {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .calendar-nav button:hover {
        background: var(--primary-hover);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .calendar-day {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 0.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .calendar-day:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .calendar-day.today {
        background: rgba(76, 175, 80, 0.2);
        border-color: var(--primary-color);
      }

      .calendar-day.has-data {
        border-width: 2px;
      }

      .calendar-day.efficient {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .calendar-day.inefficient {
        border-color: #ff4757;
        background: rgba(255, 71, 87, 0.1);
      }

      .calendar-day.empty {
        background: transparent;
        border: none;
        cursor: default;
      }

      .stats-container {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .stats-container h4 {
        color: #333;
        margin-bottom: 1rem;
        font-weight: 400;
      }

      .stats-chart {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        height: 200px;
        gap: 0.5rem;
      }

      .chart-bar {
        background: var(--primary-color);
        border-radius: 4px 4px 0 0;
        width: 30px;
        position: relative;
        transition: height 0.3s ease;
      }

      .chart-bar.efficient {
        background: #4caf50;
      }

      .chart-bar.inefficient {
        background: #ff4757;
      }

      .chart-value {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8rem;
        color: #333;
        font-weight: bold;
      }

      .chart-label {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.7rem;
        color: #666;
      }

      .day-details {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
        border-left: 4px solid var(--primary-color);
      }

      .day-details p {
        margin: 0.5rem 0;
        color: #333;
      }
    </style>
  </head>
  <body>
    <!-- æ¬¢è¿ç•Œé¢ -->
    <div
      id="welcomeScreen"
      class="welcome-screen"
      onclick="skipWelcomeAnimation()"
    >
      <h1>æ¬¢è¿ï¼</h1>
      <p
        style="
          position: absolute;
          bottom: 2rem;
          left: 0;
          right: 0;
          text-align: center;
          font-size: 0.9rem;
          color: #888;
        "
      >
        ç‚¹å‡»ä»»æ„ä½ç½®è·³è¿‡
      </p>
    </div>

    <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
    <div id="loginScreen" class="login-screen">
      <div class="login-container">
        <h2 id="authTitle">æ¬¢è¿å›æ¥</h2>
        <form id="authForm">
          <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input
              type="text"
              id="username"
              placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
              required
              title="ç”¨æˆ·åè¾“å…¥æ¡†"
              aria-label="ç”¨æˆ·å"
            />
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input
              type="password"
              id="password"
              placeholder="è¯·è¾“å…¥å¯†ç "
              required
              title="å¯†ç è¾“å…¥æ¡†"
              aria-label="å¯†ç "
            />
          </div>
          <div class="form-group remember-me">
            <input
              type="checkbox"
              id="rememberMe"
              title="è®°ä½æˆ‘"
              aria-label="è®°ä½æˆ‘"
            />
            <label for="rememberMe">è®°ä½æˆ‘</label>
          </div>
          <button type="submit" class="btn" id="authButton">ç™»å½•</button>
          <div class="toggle-link">
            <span id="toggleText">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
            <a href="#" id="toggleLink">ç«‹å³æ³¨å†Œ</a>
          </div>
        </form>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainApp" class="main-app">
      <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
      <div class="top-header">
        <div class="header-left">
          <span>é‡‘å¸: <span id="headerCoins">0</span></span>
          <span>é’»çŸ³: <span id="headerDiamonds">0</span></span>
        </div>
        <div class="header-right" onclick="switchTab('profile')">
          <!-- å…¬å‘Šé€šçŸ¥å›¾æ ‡ -->
          <div class="announcement-icon" onclick="event.stopPropagation(); showAnnouncementBoard()" title="å…¬å‘Š">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm1-13h-2v6h2V7zm0 8h-2v2h2v-2z"/>
            </svg>
            <span style="font-size: 0.9rem; white-space: nowrap;">å…¬å‘Š</span>
          </div>
          <div class="user-avatar" id="headerAvatar">
            <span id="headerAvatarText">U</span>
            <img id="headerAvatarImg" style="display: none" alt="ç”¨æˆ·å¤´åƒ" />
            <input
              type="file"
              id="avatarUpload"
              accept="image/*"
              style="display: none"
              onchange="uploadAvatar(event)"
              title="ä¸Šä¼ å¤´åƒ"
              aria-label="ä¸Šä¼ å¤´åƒ"
            />
          </div>
          <span class="username" id="headerUsername">ç”¨æˆ·å</span>
        </div>
      </div>
      <div class="content-area">
        <!-- ä»£åŠç•Œé¢ -->
        <div id="todoSection" class="todo-section">
          <div class="todo-header">
            <h2>æˆ‘çš„ä»£åŠ</h2>
          </div>

          <div class="todo-stats">
            <div
              class="stat-card"
              onclick="toggleShowAllTasks()"
              style="cursor: pointer; transition: all 0.3s ease"
              id="totalTasksCard"
            >
              <div class="stat-number" id="totalTasks">0</div>
              <div>æ€»ä»»åŠ¡</div>
            </div>
            <div
              class="stat-card"
              onclick="toggleShowCompletedOnly()"
              style="cursor: pointer; transition: all 0.3s ease"
              id="completedTasksCard"
            >
              <div class="stat-number" id="completedTasks">0</div>
              <div>å·²å®Œæˆ</div>
            </div>
            <div
              class="stat-card"
              onclick="toggleShowPendingOnly()"
              style="cursor: pointer; transition: all 0.3s ease"
              id="pendingTasksCard"
            >
              <div class="stat-number" id="pendingTasks">0</div>
              <div>æœªå®Œæˆ</div>
            </div>
          </div>
          <div class="todo-list" id="todoList"></div>
        </div>

        <!-- å·¥å…·ç•Œé¢ -->
        <div id="toolsSection" class="tools-section">
          <h2>å·¥å…·ç®±</h2>
          <div
            style="
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
              justify-content: center;
              margin-top: 1.5rem;
            "
          >
            <!-- ç•ªèŒ„é’Ÿå·¥å…· -->
            <div
              onclick="showEmptyPage('ç•ªèŒ„é’Ÿ')"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">â°</div>
              <div style="font-weight: bold">ç•ªèŒ„é’Ÿ</div>
            </div>

            <!-- è‡ªå¾‹æ—¥å†å·¥å…· -->
            <div
              onclick="showLearningCalendar()"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">ğŸ“…</div>
              <div style="font-weight: bold">è‡ªå¾‹æ—¥å†</div>
            </div>

            <!-- é”æœºå·¥å…· -->
            <div
              onclick="showEmptyPage('é”æœº')"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">ğŸ”’</div>
              <div style="font-weight: bold">é”æœº</div>
            </div>

            <!-- å±è”½ç½‘ç«™å·¥å…· -->
            <div
              onclick="showEmptyPage('å±è”½ç½‘ç«™')"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">ğŸš«</div>
              <div style="font-weight: bold">å±è”½ç½‘ç«™</div>
            </div>
          </div>

          <!-- ç©ºç™½é¡µé¢å®¹å™¨ -->
          <div id="emptyPageContainer" style="margin-top: 2rem; display: none">
            <h3 id="emptyPageTitle" style="text-align: center"></h3>
          </div>
        </div>

        <!-- å•†åŸç•Œé¢ -->
        <div id="shopSection" class="shop-section">
          <h2>é‡‘å¸å•†åŸ</h2>
          <div
            class="shop-container"
            style="
              display: flex;
              flex-direction: column;
              gap: 1.5rem;
              max-width: 400px;
              margin: 0 auto;
            "
          >
            <!-- æŠ½å¥–åŒºåŸŸ -->
            <div
              class="shop-card"
              onclick="showLottery()"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 2rem;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(var(--blur-amount));
              "
              onmouseover="this.style.transform='translateY(-5px)'"
              onmouseout="this.style.transform='translateY(0)'"
            >
              <div style="font-size: 3rem; margin-bottom: 1rem">ğŸ°</div>
              <h3 style="color: var(--primary-color); margin-bottom: 0.5rem">
                å¹¸è¿æŠ½å¥–
              </h3>
              <p style="color: #666; font-size: 0.9rem">
                æ¶ˆè€—é‡‘å¸å‚ä¸æŠ½å¥–ï¼Œèµ¢å–é’»çŸ³å¥–åŠ±
              </p>
              <div style="margin-top: 1rem; color: #ff6b6b; font-weight: bold">
                100 é‡‘å¸/æ¬¡
              </div>
            </div>

            <!-- å…‘æ¢åŒºåŸŸ -->
            <div
              class="shop-card"
              onclick="showExchange()"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 2rem;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(var(--blur-amount));
              "
              onmouseover="this.style.transform='translateY(-5px)'"
              onmouseout="this.style.transform='translateY(0)'"
            >
              <div style="font-size: 3rem; margin-bottom: 1rem">âš–ï¸</div>
              <h3 style="color: var(--primary-color); margin-bottom: 0.5rem">
                è´§å¸å…‘æ¢
              </h3>
              <p style="color: #666; font-size: 0.9rem">
                é‡‘å¸ã€é’»çŸ³ã€è‡ªå¾‹å¸äº’ç›¸å…‘æ¢
              </p>
              <div style="margin-top: 1rem; color: #4ecdc4; font-weight: bold">
                å¤šç§å…‘æ¢é€‰é¡¹
              </div>
            </div>
          </div>

          <!-- æŠ½å¥–ç•Œé¢ -->
          <div id="lotterySection" style="display: none; margin-top: 2rem">
            <div
              style="
                text-align: center;
                padding: 2rem;
                max-width: 500px;
                margin: 0 auto;
              "
            >
              <h3>ğŸ° å¹¸è¿æŠ½å¥–</h3>
              <div style="margin: 2rem 0">
                <div
                  style="
                    font-size: 4rem;
                    margin-bottom: 1rem;
                    display: flex;
                    gap: 2rem;
                    justify-content: center;
                  "
                >
                  <div>ğŸ’</div>
                  <div>ğŸª™</div>
                </div>
                <h4>å½“å‰é’»çŸ³: <span id="diamondCount">0</span></h4>
                <h4>å½“å‰è‡ªå¾‹å¸: <span id="disciplineCoinCount">0</span></h4>
                <p style="color: #666; margin: 0.5rem 0">
                  é’»çŸ³æ¦‚ç‡: <strong>5.1%</strong> (10æŠ½ä¿åº•)<br />
                  è‡ªå¾‹å¸æ¦‚ç‡: <strong>0.6%</strong> (90æŠ½ä¿åº•)<br />
                  é’»çŸ³ä¿åº•è¿›åº¦: <span id="guaranteeCount">0</span>/10<br />
                  è‡ªå¾‹å¸ä¿åº•è¿›åº¦:
                  <span id="disciplineGuaranteeCount">0</span>/90
                </p>
              </div>

              <div
                style="
                  display: flex;
                  gap: 1rem;
                  justify-content: center;
                  margin: 2rem 0;
                "
              >
                <button
                  onclick="singleDraw()"
                  style="
                    padding: 1rem 2rem;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 1.1rem;
                    transition: all 0.3s ease;
                  "
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                >
                  å•æŠ½ (100é‡‘å¸)
                </button>
                <button
                  onclick="tenDraw()"
                  style="
                    padding: 1rem 2rem;
                    background: #ff6b6b;
                    color: white;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 1.1rem;
                    transition: all 0.3s ease;
                  "
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                >
                  åè¿æŠ½ (1000é‡‘å¸)
                </button>
              </div>

              <div
                id="lotteryResult"
                style="margin: 1rem 0; min-height: 2rem"
              ></div>

              <button
                onclick="hideLottery()"
                style="
                  margin-top: 1rem;
                  padding: 0.5rem 1.5rem;
                  background: #666;
                  color: white;
                  border: none;
                  border-radius: 20px;
                  cursor: pointer;
                "
              >
                è¿”å›å•†åŸ
              </button>
            </div>
          </div>

          <!-- å…‘æ¢ç•Œé¢ -->
          <div id="exchangeSection" style="display: none; margin-top: 2rem">
            <div
              style="
                text-align: center;
                padding: 2rem;
                max-width: 500px;
                margin: 0 auto;
              "
            >
              <h3>ğŸ’° è´§å¸å…‘æ¢</h3>
              <div style="margin: 2rem 0">
                <div style="font-size: 4rem; margin-bottom: 1rem">âš–ï¸</div>
                <div
                  style="
                    display: flex;
                    justify-content: space-around;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: center">
                    <p>å½“å‰é‡‘å¸</p>
                    <h4><span id="exchangeCoinCount">0</span></h4>
                  </div>
                  <div style="text-align: center">
                    <p>å½“å‰é’»çŸ³</p>
                    <h4><span id="exchangeDiamondCount">0</span></h4>
                  </div>
                  <div style="text-align: center">
                    <p>å½“å‰è‡ªå¾‹å¸</p>
                    <h4><span id="exchangeDisciplineCoinCount">0</span></h4>
                  </div>
                </div>
                <p style="color: #666; margin: 0.5rem 0">
                  å…‘æ¢å„ç§è´§å¸ï¼Œæ»¡è¶³ä¸åŒéœ€æ±‚
                </p>
              </div>

              <!-- é‡‘å¸å…‘æ¢å…¶ä»–è´§å¸ -->
              <div
                style="
                  background: rgba(255, 255, 255, var(--text-box-opacity));
                  padding: 2rem;
                  border-radius: 15px;
                  margin: 2rem 0;
                "
              >
                <h4 style="margin-bottom: 1rem">é‡‘å¸å…‘æ¢</h4>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 é¢—é’»çŸ³</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >ç¨€æœ‰è´§å¸ï¼Œå¯ç”¨äºç‰¹æ®ŠåŠŸèƒ½</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="exchangeDiamonds()"
                      style="
                        padding: 0.5rem 1rem;
                        background: var(--primary-color);
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      900 é‡‘å¸å…‘æ¢
                    </button>
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 æšè‡ªå¾‹å¸</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >é«˜çº§è´§å¸ï¼Œç”¨äºé«˜çº§åŠŸèƒ½</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="exchangeDisciplineCoins()"
                      style="
                        padding: 0.5rem 1rem;
                        background: var(--primary-color);
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      25000 é‡‘å¸å…‘æ¢
                    </button>
                  </div>
                </div>
              </div>

              <!-- å…¶ä»–è´§å¸å…‘æ¢å›é‡‘å¸ -->
              <div
                style="
                  background: rgba(255, 255, 255, var(--text-box-opacity));
                  padding: 2rem;
                  border-radius: 15px;
                  margin: 2rem 0;
                "
              >
                <h4 style="margin-bottom: 1rem">å…‘æ¢å›é‡‘å¸</h4>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 é¢—é’»çŸ³ â†’ é‡‘å¸</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >å°†é’»çŸ³è½¬æ¢å›é‡‘å¸</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="convertDiamondsToCoins()"
                      style="
                        padding: 0.5rem 1rem;
                        background: #4caf50;
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      å…‘æ¢ 900 é‡‘å¸
                    </button>
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 æšè‡ªå¾‹å¸ â†’ é‡‘å¸</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >å°†è‡ªå¾‹å¸è½¬æ¢å›é‡‘å¸</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="convertDisciplineCoinsToCoins()"
                      style="
                        padding: 0.5rem 1rem;
                        background: #4caf50;
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      å…‘æ¢ 25000 é‡‘å¸
                    </button>
                  </div>
                </div>
              </div>

              <div
                id="exchangeResult"
                style="margin: 1rem 0; min-height: 2rem"
              ></div>

              <button
                onclick="hideExchange()"
                style="
                  margin-top: 1rem;
                  padding: 0.5rem 1.5rem;
                  background: #666;
                  color: white;
                  border: none;
                  border-radius: 20px;
                  cursor: pointer;
                "
              >
                è¿”å›å•†åŸ
              </button>
            </div>
          </div>
        </div>

        <!-- æˆ‘çš„ç•Œé¢ -->
        <div id="profileSection" class="profile-section">
          <div class="profile-header">
            <div
              class="profile-avatar"
              id="profileAvatar"
              style="cursor: pointer"
              title="ç‚¹å‡»ä¸Šä¼ å¤´åƒ"
            >
              U
            </div>
            <h2 id="profileName">ç”¨æˆ·å</h2>
            <p>é‡‘å¸: <span id="profileCoins">0</span></p>
            <p>é’»çŸ³: <span id="profileDiamonds">0</span></p>
            <p>è‡ªå¾‹å¸: <span id="profileDisciplineCoins">0</span></p>
            <input
              type="text"
              id="profileSignature"
              placeholder="è®¾ç½®ä¸ªæ€§ç­¾å"
              style="
                border: none;
                background: transparent;
                text-align: center;
                color: #666;
                font-size: 0.9rem;
                margin-top: 0.5rem;
                width: 100%;
              "
              maxlength="30"
            />
          </div>



          <div class="profile-info">
            <div class="info-item">
              <span>æˆå°±</span>
              <span>å¼€å‘ä¸­</span>
            </div>
            <div class="info-item">
              <span>ç­‰çº§</span>
              <span>å¼€å‘ä¸­</span>
            </div>
            <div class="info-item">
              <span>æ®µä½</span>
              <span>å¼€å‘ä¸­</span>
            </div>
            <div class="info-item">
              <span>æ³¨å†Œæ—¶é—´</span>
              <span id="profileRegister">-</span>
            </div>
          </div>

          <!-- ç¤¼åŒ…ç åŠŸèƒ½ -->
          <div
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">ç¤¼åŒ…ç å…‘æ¢</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center">
              <input
                type="text"
                id="giftCodeInput"
                placeholder="è¯·è¾“å…¥ç¤¼åŒ…ç "
                style="
                  flex: 1;
                  padding: 0.5rem;
                  border: 1px solid #ddd;
                  border-radius: 20px;
                  outline: none;
                "
                maxlength="20"
                title="ç¤¼åŒ…ç è¾“å…¥æ¡†"
                aria-label="ç¤¼åŒ…ç "
              />
              <button
                onclick="redeemGiftCode()"
                style="
                  padding: 0.5rem 1rem;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 20px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                å…‘æ¢
              </button>
            </div>
            <div
              id="giftCodeResult"
              style="margin-top: 0.5rem; min-height: 1.5rem; font-size: 0.9rem"
            ></div>
          </div>

          <!-- ä¸ªæ€§åŒ–è®¾ç½® -->
          <div
            class="profile-settings"
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">ä¸ªæ€§åŒ–è®¾ç½®</h3>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >ä¸»é¢˜é¢œè‰²</label
              >
              <div
                class="color-picker"
                style="display: flex; gap: 0.5rem; flex-wrap: wrap"
              >
                <div
                  class="color-option"
                  data-color="#667eea"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #667eea;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#ff6b6b"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #ff6b6b;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#4ecdc4"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #4ecdc4;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#45b7d1"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #45b7d1;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#96ceb4"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #96ceb4;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#feca57"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #feca57;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#ff9ff3"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #ff9ff3;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#54a0ff"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #54a0ff;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#00cc66"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #00cc66;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
              </div>
            </div>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >ç•Œé¢é€æ˜åº¦ï¼ˆç™½è‰²èƒŒæ™¯ï¼‰</label
              >
              <input
                type="range"
                id="contentOpacitySlider"
                min="0"
                max="1"
                step="0.05"
                value="0.95"
                style="width: 100%; margin-bottom: 0.5rem"
              />
              <span
                id="contentOpacityValue"
                style="font-size: 0.8rem; color: #666"
                >95%</span
              >
            </div>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >æ–‡å­—æ¡†é€æ˜åº¦ï¼ˆä»»åŠ¡å¡ç‰‡ï¼‰</label
              >
              <input
                type="range"
                id="textBoxOpacitySlider"
                min="0"
                max="1"
                step="0.05"
                value="0.9"
                style="width: 100%; margin-bottom: 0.5rem"
              />
              <span
                id="textBoxOpacityValue"
                style="font-size: 0.8rem; color: #666"
                >90%</span
              >
            </div>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >èƒŒæ™¯æ¨¡ç³Šç¨‹åº¦</label
              >
              <input
                type="range"
                id="blurSlider"
                min="0"
                max="20"
                step="1"
                value="10"
                style="width: 100%; margin-bottom: 0.5rem"
              />
              <span id="blurValue" style="font-size: 0.8rem; color: #666"
                >10px</span
              >
            </div>

            <div class="setting-item">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >èƒŒæ™¯å›¾ç‰‡</label
              >
              <input
                type="file"
                id="bgUpload"
                accept="image/*"
                style="display: none"
              />
              <button
                onclick="document.getElementById('bgUpload').click()"
                style="
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 5px;
                  cursor: pointer;
                  margin-right: 0.5rem;
                "
              >
                ä¸Šä¼ èƒŒæ™¯
              </button>
              <button
                onclick="removeBackground()"
                style="
                  background: #ccc;
                  color: #333;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 5px;
                  cursor: pointer;
                "
              >
                ç§»é™¤èƒŒæ™¯
              </button>
            </div>
          </div>

          <!-- ç³»ç»Ÿè®¾ç½® -->
          <div
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">ç³»ç»Ÿè®¾ç½®</h3>
            <div
              style="
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
              "
            >
              <button
                onclick="clearCache()"
                style="
                  background: #ff9500;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                æ¸…ç†ç¼“å­˜
              </button>
              <button
                onclick="deleteAccount()"
                style="
                  background: #ff4757;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                æ³¨é”€è´¦å·
              </button>
            </div>
          </div>

          <!-- å…³äºæˆ‘ä»¬ -->
          <div
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">å…³äºæˆ‘ä»¬</h3>
            <div
              style="
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
              "
            >
              <button
                onclick="joinUs()"
                style="
                  background: #54a0ff;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                åŠ å…¥æˆ‘ä»¬
              </button>
              <button
                onclick="feedbackError()"
                style="
                  background: #4ecdc4;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                åé¦ˆé”™è¯¯
              </button>
            </div>
          </div>

          <!-- ç™»å‡ºæŒ‰é’® -->
          <div style="margin-top: 2rem; text-align: center">
            <button
              onclick="logout()"
              style="
                background: #ff4757;
                color: white;
                border: none;
                padding: 0.75rem 2rem;
                border-radius: 25px;
                cursor: pointer;
                font-size: 1rem;
              "
            >
              ç™»å‡ºè´¦å·
            </button>
          </div>
        </div>
      </div>

      <!-- å…¬å‘Šæ¿ç•Œé¢ -->
      <div
        id="announcementBoard"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
        "
      >
        <div
          style="
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(var(--blur-amount));
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1.5rem;
            "
          >
            <h2
              style="
                color: #333;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <i>ğŸ“¢</i>
              å…¬å‘Šæ¿
            </h2>
            <button
              onclick="hideAnnouncementBoard()"
              style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #666;
                padding: 0.25rem;
              "
            >
              Ã—
            </button>
          </div>

          <div id="announcementList">
            <div
              class="announcement-item"
              style="
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                background: #f8f9fa;
                border-radius: 15px;
                border-left: 4px solid var(--primary-color);
              "
            >
              <h4 style="margin: 0 0 0.5rem 0; color: #333">è‡ªå¾‹åŠ©æ‰‹ä¸Šçº¿å•¦ï¼</h4>
              <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem">
                è‡ªå¾‹åŠ©æ‰‹æ˜¯ä¸€æ¬¾å¸®åŠ©ä½ æå‡æ•ˆç‡ã€åŸ¹å…»å¥½ä¹ æƒ¯çš„å¤šåŠŸèƒ½å·¥å…·ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
              </p>
              <ul style="margin: 0 0 0.5rem 1.5rem; color: #666; font-size: 0.9rem">
                <li>ğŸ“‹ ä»£åŠä»»åŠ¡ç®¡ç† - è®°å½•å’Œè¿½è¸ªä½ çš„å¾…åŠäº‹é¡¹</li>
                <li>ğŸ… ç•ªèŒ„é’Ÿä¸“æ³¨ - æé«˜ä¸“æ³¨åŠ›å’Œå·¥ä½œæ•ˆç‡</li>
                <li>ğŸ”’ é”æœºåŠŸèƒ½ - é¿å…åˆ†å¿ƒï¼Œä¿æŒè‡ªå¾‹</li>
                <li>ğŸš« ç½‘ç«™å±è”½ - å±è”½å¹²æ‰°ç½‘ç«™ï¼Œä¿æŒä¸“æ³¨</li>
                <li>ğŸ® ç§¯åˆ†ç³»ç»Ÿ - é‡‘å¸ã€é’»çŸ³å’Œè‡ªå¾‹å¸å¥–åŠ±æœºåˆ¶</li>
                <li>ğŸ° å¹¸è¿æŠ½å¥– - ä½¿ç”¨é’»çŸ³å‚ä¸æŠ½å¥–è·å¾—å¥–åŠ±</li>
                <li>ğŸ‘¤ ä¸ªäººä¸­å¿ƒ - ç®¡ç†ä¸ªäººä¿¡æ¯å’Œè®¾ç½®</li>
              </ul>
              <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem">
                ç«‹å³å¼€å§‹ä½¿ç”¨è‡ªå¾‹åŠ©æ‰‹ï¼ŒåŸ¹å…»è‡ªå¾‹ä¹ æƒ¯ï¼Œæå‡ç”Ÿæ´»å“è´¨ï¼
              </p>
              <span style="color: #999; font-size: 0.8rem">åˆšåˆš</span>
            </div>
          </div>

          <button
            onclick="hideAnnouncementBoard()"
            style="
              width: 100%;
              padding: 0.75rem;
              background: #666;
              color: white;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-size: 1rem;
              margin-top: 1rem;
            "
          >
            å…³é—­
          </button>
        </div>
      </div>

      <!-- åº•éƒ¨å¯¼èˆª -->
      <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('todo')">
          <i>ğŸ“‹</i>
          <span>ä»£åŠ</span>
        </div>
        <div class="nav-item" onclick="switchTab('tools')">
          <i>ğŸ”§</i>
          <span>å·¥å…·</span>
        </div>
        <div class="nav-item" onclick="switchTab('shop')">
          <i>ğŸ›’</i>
          <span>å•†åŸ</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
          <i>ğŸ‘¤</i>
          <span>æˆ‘çš„</span>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ ä»»åŠ¡å¼¹çª— -->
    <div id="addTodoModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="todoModalTitle">æ·»åŠ æ–°ä»»åŠ¡</h3>
          <button class="close-btn" onclick="closeAddTodo()">&times;</button>
        </div>
        <form id="addTodoForm">
          <div class="form-group">
            <label>ä»»åŠ¡å†…å®¹</label>
            <input
              type="text"
              id="todoContent"
              placeholder="è¯·è¾“å…¥ä»»åŠ¡å†…å®¹"
              required
            />
          </div>
          <div class="form-group">
            <label>æˆªæ­¢æ—¶é—´</label>
            <input
              type="datetime-local"
              id="todoDeadline"
              required
              title="ä»»åŠ¡æˆªæ­¢æ—¶é—´"
              aria-label="ä»»åŠ¡æˆªæ­¢æ—¶é—´"
            />
          </div>
          <div class="form-group">
            <label>ä¼˜å…ˆçº§</label>
            <select
              id="todoPriority"
              required
              title="ä»»åŠ¡ä¼˜å…ˆçº§é€‰æ‹©"
              aria-label="ä»»åŠ¡ä¼˜å…ˆçº§"
            >
              <option value="low">ä½</option>
              <option value="medium" selected>ä¸­</option>
              <option value="high">é«˜</option>
            </select>
          </div>
          <div class="form-group">
            <label>å¤‡æ³¨</label>
            <textarea
              id="todoNotes"
              placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
              rows="3"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                resize: vertical;
                outline: none;
                font-family: inherit;
              "
            ></textarea>
          </div>

          <button type="submit" class="btn" id="todoSubmitBtn">æ·»åŠ ä»»åŠ¡</button>
        </form>
      </div>
    </div>

    <!-- æ·»åŠ ä»»åŠ¡æŒ‰é’® -->
    <button
      class="add-todo-btn"
      onclick="showAddTodo()"
      id="addTodoBtn"
      style="opacity: 0; visibility: hidden"
    >
      +
    </button>

    <script>
      // å…¨å±€å˜é‡
      let currentUser = null;
      let todos = [];
      let isLoginMode = true;
      let showCompletedOnly = false;
      let showAllTasks = true;
      let showPendingOnly = false;
      let diamonds = 0;
      let lotteryCount = 0; // é’»çŸ³æŠ½å¥–æ¬¡æ•°ï¼Œç”¨äºä¿åº•è®¡ç®—
      let disciplineLotteryCount = 0; // è‡ªå¾‹å¸æŠ½å¥–æ¬¡æ•°ï¼Œç”¨äºä¿åº•è®¡ç®—
      let disciplineCoins = 0; // è‡ªå¾‹å¸æ•°é‡

      // åœ¨é¡¶éƒ¨å¯¼èˆªæ æ·»åŠ è‡ªå¾‹å¸æ˜¾ç¤º
      function addDisciplineCoinsToHeader() {
        // æ£€æŸ¥è‡ªå¾‹å¸æ˜¾ç¤ºå…ƒç´ æ˜¯å¦å·²ç»å­˜åœ¨
        if (!document.getElementById("disciplineCoinsDisplay")) {
          // æ‰¾åˆ°ç°æœ‰çš„header-left
          const headerLeft = document.querySelector(".top-header .header-left");
          if (headerLeft) {
            // ç›´æ¥åœ¨ç°æœ‰çš„header-leftä¸­æ·»åŠ è‡ªå¾‹å¸æ˜¾ç¤º
            const disciplineCoinsElement = document.createElement("span");
            disciplineCoinsElement.id = "disciplineCoinsDisplay";
            disciplineCoinsElement.innerHTML =
              ' è‡ªå¾‹å¸: <span id="topDisciplineCoins">0</span>';

            // æ·»åŠ åˆ°header-leftä¸­
            headerLeft.appendChild(disciplineCoinsElement);
          }
        }
      }

      // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„è‡ªå¾‹å¸æ˜¾ç¤º
      function updateTopHeaderCurrencies() {
        const topDisciplineCoins =
          document.getElementById("topDisciplineCoins");
        if (topDisciplineCoins) {
          topDisciplineCoins.textContent = disciplineCoins;
        }
      }

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        initApp();

        // å»¶è¿Ÿæ·»åŠ è‡ªå¾‹å¸æ˜¾ç¤ºï¼Œç¡®ä¿headerå…ƒç´ å·²ç»å®Œå…¨åŠ è½½
        setTimeout(() => {
          addDisciplineCoinsToHeader();
        }, 100);
      });

      // æ˜¾ç¤ºå…¬å‘Šæ¿ç•Œé¢
      function showAnnouncementBoard() {
        const announcementBoard = document.getElementById("announcementBoard");
        announcementBoard.style.display = "flex";
        document.body.style.overflow = "hidden"; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
      }

      // éšè—å…¬å‘Šæ¿ç•Œé¢
      function hideAnnouncementBoard() {
        const announcementBoard = document.getElementById("announcementBoard");
        announcementBoard.style.display = "none";
        document.body.style.overflow = ""; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
      }

      // åœ¨å•†åŸç•Œé¢å¢åŠ è‡ªå¾‹å¸å…‘æ¢æŒ‰é’®
      function updateExchangeSection() {
        const exchangeSection = document.querySelector("#exchangeDiamonds");
        if (
          exchangeSection &&
          !document.querySelector("#exchangeDisciplineCoins")
        ) {
          const disciplineExchangeBtn = document.createElement("button");
          disciplineExchangeBtn.id = "exchangeDisciplineCoins";
          disciplineExchangeBtn.onclick = exchangeDisciplineCoins;
          disciplineExchangeBtn.style.cssText = `
            margin-top: 1rem;
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, #ffa502, #ff6348);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
          `;
          disciplineExchangeBtn.innerHTML = "25000 é‡‘å¸å…‘æ¢ 1 è‡ªå¾‹å¸";

          disciplineExchangeBtn.onmouseover = function () {
            this.style.transform = "scale(1.02)";
          };
          disciplineExchangeBtn.onmouseout = function () {
            this.style.transform = "scale(1)";
          };

          exchangeSection.parentNode.appendChild(disciplineExchangeBtn);
        }
      }

      // ç›‘å¬å•†åŸç•Œé¢åˆ‡æ¢ï¼Œæ·»åŠ è‡ªå¾‹å¸å…‘æ¢æŒ‰é’®
      document.addEventListener("click", function (e) {
        if (
          e.target.closest(".nav-item") &&
          e.target.closest(".nav-item").textContent.includes("å•†åŸ")
        ) {
          setTimeout(updateExchangeSection, 500);
        }
      });

      // æŠ½å¥–åŠŸèƒ½
      function singleDraw() {
        if (coins < 100) {
          document.getElementById("lotteryResult").innerHTML =
            '<p style="color: #ff6b6b;">é‡‘å¸ä¸è¶³ï¼éœ€è¦100é‡‘å¸å‚ä¸æŠ½å¥–</p>';
          return;
        }

        coins -= 100;
        lotteryCount++;
        disciplineLotteryCount++;

        // é’»çŸ³ä¸­å¥–åˆ¤å®šï¼ˆ5.1%æ¦‚ç‡æˆ–10æŠ½ä¿åº•ï¼‰
        const isDiamondWin = Math.random() < 0.051 || lotteryCount >= 10;
        // è‡ªå¾‹å¸ä¸­å¥–åˆ¤å®šï¼ˆ0.6%æ¦‚ç‡æˆ–90æŠ½ä¿åº•ï¼‰
        const isDisciplineWin =
          Math.random() < 0.006 || disciplineLotteryCount >= 90;

        let prizeType = "coin"; // é»˜è®¤è·å¾—1é‡‘å¸

        if (isDisciplineWin) {
          // è‡ªå¾‹å¸ä¸­å¥–ï¼ˆä¼˜å…ˆçº§é«˜äºé’»çŸ³ï¼‰
          disciplineCoins++;
          disciplineLotteryCount = 0;
          prizeType = "discipline";
        } else if (isDiamondWin) {
          // é’»çŸ³ä¸­å¥–
          diamonds++;
          lotteryCount = 0;
          prizeType = "diamond";
        } else {
          // æœªä¸­é’»çŸ³å’Œè‡ªå¾‹å¸ï¼Œè·å¾—1é‡‘å¸
          coins++;
        }

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateTopHeaderCurrencies();

        let resultText, prizeIcon;
        switch (prizeType) {
          case "diamond":
            resultText = "æ­å–œè·å¾—é’»çŸ³ï¼";
            prizeIcon = "ğŸ’";
            break;
          case "discipline":
            resultText = "æ­å–œè·å¾—è‡ªå¾‹å¸ï¼";
            prizeIcon = "ğŸª™";
            break;
          default:
            resultText = "è·å¾—1é‡‘å¸ï¼";
            prizeIcon = "ğŸ’°";
        }

        // æ·»åŠ åŠ¨ç”»æ•ˆæœçš„ä¸­å¥–æ˜¾ç¤º
        const resultElement = document.getElementById("lotteryResult");
        resultElement.innerHTML = "";

        const resultDiv = document.createElement("div");
        resultDiv.style.cssText = `
          margin: 1rem 0;
          padding: 1.5rem;
          border-radius: 15px;
          text-align: center;
          transition: all 0.5s ease;
          position: relative;
          overflow: hidden;
        `;

        if (prizeType !== "coin") {
          // ä¸­å¥–æ ·å¼ (é’»çŸ³æˆ–è‡ªå¾‹å¸)
          resultDiv.style.background =
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
          resultDiv.style.boxShadow = "0 10px 30px rgba(79, 172, 254, 0.5)";

          // æ·»åŠ é—ªå…‰æ•ˆæœ
          const shine = document.createElement("div");
          shine.style.cssText = `
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
              to bottom right,
              rgba(255,255,255,0) 0%,
              rgba(255,255,255,0.8) 50%,
              rgba(255,255,255,0) 100%
            );
            transform: rotate(30deg);
            animation: shine 1s ease;
          `;
          resultDiv.appendChild(shine);
        }

        // å¥–å“å›¾æ ‡
        const iconDiv = document.createElement("div");
        iconDiv.style.fontSize = "5rem";
        iconDiv.style.marginBottom = "1rem";
        iconDiv.style.animation = prizeType !== "coin" ? "bounce 1s ease" : "";
        iconDiv.textContent = prizeIcon;
        resultDiv.appendChild(iconDiv);

        // ç»“æœæ–‡æœ¬
        const textStrong = document.createElement("strong");
        textStrong.style.fontSize = "1.5rem";
        textStrong.style.color = prizeType !== "coin" ? "#fff" : "#333";
        textStrong.textContent = resultText;
        resultDiv.appendChild(textStrong);

        // æ¢è¡Œ
        resultDiv.appendChild(document.createElement("br"));

        // è¯¦ç»†ä¿¡æ¯
        const detailsDiv = document.createElement("div");
        detailsDiv.style.marginTop = "1rem";
        detailsDiv.style.color =
          prizeType !== "coin" ? "rgba(255,255,255,0.9)" : "#666";
        detailsDiv.innerHTML = `
          <br>å‰©ä½™é‡‘å¸: ${coins}
          <br>å½“å‰é’»çŸ³: ${diamonds}
          <br>é’»çŸ³ä¿åº•è¿›åº¦: ${lotteryCount}/10
          <br>è‡ªå¾‹å¸ä¿åº•è¿›åº¦: ${disciplineLotteryCount}/90
        `;
        resultDiv.appendChild(detailsDiv);

        resultElement.appendChild(resultDiv);

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement("style");
        style.textContent = `
          @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
          }
          @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
          }
        `;
        document.head.appendChild(style);
        setTimeout(() => document.head.removeChild(style), 2000);

        showNotification(resultText);
      }

      function tenDraw() {
        if (coins < 1000) {
          document.getElementById("lotteryResult").innerHTML =
            '<p style="color: #ff6b6b;">é‡‘å¸ä¸è¶³ï¼éœ€è¦1000é‡‘å¸å‚ä¸åè¿æŠ½</p>';
          return;
        }

        coins -= 1000;
        let totalDiamonds = 0;
        let totalDisciplineCoins = 0;
        let results = [];

        for (let i = 0; i < 10; i++) {
          lotteryCount++;
          disciplineLotteryCount++;

          // é’»çŸ³ä¸­å¥–åˆ¤å®šï¼ˆ5.1%æ¦‚ç‡æˆ–10æŠ½ä¿åº•ï¼‰
          const isDiamondWin = Math.random() < 0.051 || lotteryCount >= 10;
          // è‡ªå¾‹å¸ä¸­å¥–åˆ¤å®šï¼ˆ0.6%æ¦‚ç‡æˆ–90æŠ½ä¿åº•ï¼‰
          const isDisciplineWin =
            Math.random() < 0.006 || disciplineLotteryCount >= 90;

          let prizeType = "coin"; // é»˜è®¤è·å¾—1é‡‘å¸

          if (isDisciplineWin) {
            // è‡ªå¾‹å¸ä¸­å¥–ï¼ˆä¼˜å…ˆçº§é«˜äºé’»çŸ³ï¼‰
            disciplineCoins++;
            totalDisciplineCoins++;
            disciplineLotteryCount = 0;
            prizeType = "discipline";
          } else if (isDiamondWin) {
            // é’»çŸ³ä¸­å¥–
            diamonds++;
            totalDiamonds++;
            lotteryCount = 0;
            prizeType = "diamond";
          } else {
            // æœªä¸­é’»çŸ³å’Œè‡ªå¾‹å¸ï¼Œè·å¾—1é‡‘å¸
            coins++;
          }

          // æ·»åŠ ç»“æœ
          switch (prizeType) {
            case "diamond":
              results.push("ğŸ’ é’»çŸ³");
              break;
            case "discipline":
              results.push("ğŸª™ è‡ªå¾‹å¸");
              break;
            default:
              results.push("ğŸ’° 1é‡‘å¸");
          }
        }

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateTopHeaderCurrencies();

        let resultText;
        if (totalDisciplineCoins > 0) {
          resultText = `æ­å–œè·å¾—è‡ªå¾‹å¸ x${totalDisciplineCoins}ï¼${
            totalDiamonds > 0 ? `å¹¶è·å¾—é’»çŸ³ x${totalDiamonds}ï¼` : ""
          }`;
        } else if (totalDiamonds > 0) {
          resultText = `æ­å–œè·å¾—é’»çŸ³ x${totalDiamonds}ï¼`;
        } else {
          resultText = "è·å¾—äº†ä¸€äº›é‡‘å¸ï¼";
        }

        // å¢å¼ºçš„åè¿æŠ½ç»“æœæ˜¾ç¤º
        const resultElement = document.getElementById("lotteryResult");
        resultElement.innerHTML = "";

        const resultDiv = document.createElement("div");
        resultDiv.style.cssText = `
          margin: 1rem 0;
          padding: 1.5rem;
          border-radius: 15px;
          text-align: center;
        `;

        if (totalDiamonds > 0) {
          // æœ‰ä¸­å¥–çš„æ ·å¼
          resultDiv.style.background =
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
          resultDiv.style.boxShadow = "0 10px 30px rgba(79, 172, 254, 0.5)";
        } else {
          // æœªä¸­å¥–çš„æ ·å¼
          resultDiv.style.background = "#f8f9fa";
        }

        // ç»“æœæ–‡æœ¬
        const textStrong = document.createElement("strong");
        textStrong.style.fontSize = "1.5rem";
        textStrong.style.color = totalDiamonds > 0 ? "#fff" : "#333";
        textStrong.textContent = resultText;
        resultDiv.appendChild(textStrong);

        // è¯¦ç»†ä¿¡æ¯
        const detailsDiv = document.createElement("div");
        detailsDiv.style.marginTop = "1rem";
        detailsDiv.style.color =
          totalDiamonds > 0 ? "rgba(255,255,255,0.9)" : "#666";
        detailsDiv.innerHTML = `
          <br>å‰©ä½™é‡‘å¸: ${coins}
          <br>å½“å‰é’»çŸ³: ${diamonds}
          <br>é’»çŸ³ä¿åº•è¿›åº¦: ${lotteryCount}/10
          <br>è‡ªå¾‹å¸ä¿åº•è¿›åº¦: ${disciplineLotteryCount}/90
        `;
        resultDiv.appendChild(detailsDiv);

        // åè¿æŠ½ç»“æœåˆ—è¡¨
        const resultsHeader = document.createElement("div");
        resultsHeader.style.marginTop = "1rem";
        resultsHeader.style.fontWeight = "bold";
        resultsHeader.style.color =
          totalDiamonds > 0 ? "rgba(255,255,255,0.9)" : "#333";
        resultsHeader.textContent = "åè¿æŠ½ç»“æœ:";
        resultDiv.appendChild(resultsHeader);

        const resultsGrid = document.createElement("div");
        resultsGrid.style.display = "flex";
        resultsGrid.style.flexWrap = "wrap";
        resultsGrid.style.justifyContent = "center";
        resultsGrid.style.gap = "0.5rem";
        resultsGrid.style.marginTop = "0.5rem";

        // é€ä¸ªæ·»åŠ ç»“æœï¼Œå¸¦å»¶è¿ŸåŠ¨ç”»
        results.forEach((result, index) => {
          const resultItem = document.createElement("div");
          const isItemWin =
            result.includes("é’»çŸ³") || result.includes("è‡ªå¾‹å¸");

          resultItem.style.cssText = `
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
          `;

          if (isItemWin) {
            resultItem.style.background = "rgba(255,255,255,0.2)";
            resultItem.style.color = "#fff";
            resultItem.style.boxShadow = "0 2px 8px rgba(255,255,255,0.3)";
          } else {
            resultItem.style.background = "rgba(255,255,255,0.8)";
            resultItem.style.color = "#666";
          }

          resultItem.textContent = result;
          resultsGrid.appendChild(resultItem);

          // å»¶è¿Ÿæ˜¾ç¤ºåŠ¨ç”»
          setTimeout(() => {
            resultItem.style.opacity = "1";
            resultItem.style.transform = "scale(1)";
          }, index * 150);
        });

        resultDiv.appendChild(resultsGrid);
        resultElement.appendChild(resultDiv);

        showNotification(resultText);
      }

      // ç¡®ä¿disciplineCoinså˜é‡åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å·²ç»å£°æ˜

      function exchangeDiamonds() {
        const exchangeRate = 900;
        if (coins < exchangeRate) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">é‡‘å¸ä¸è¶³ï¼éœ€è¦${exchangeRate}é‡‘å¸å…‘æ¢1é¢—é’»çŸ³</p>`;
          return;
        }

        coins -= exchangeRate;
        diamonds++;

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>å…‘æ¢æˆåŠŸï¼</strong>
              <br>æ¶ˆè€—é‡‘å¸: ${exchangeRate}
              <br>è·å¾—é’»çŸ³: 1
              <br>å‰©ä½™é‡‘å¸: ${coins}
              <br>å½“å‰é’»çŸ³: ${diamonds}
            </div>
          `;

        showNotification("æˆåŠŸå…‘æ¢1é¢—é’»çŸ³ï¼");
      }

      function exchangeDisciplineCoins() {
        const exchangeRate = 25000;
        if (coins < exchangeRate) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">é‡‘å¸ä¸è¶³ï¼éœ€è¦${exchangeRate}é‡‘å¸å…‘æ¢1æšè‡ªå¾‹å¸</p>`;
          return;
        }

        coins -= exchangeRate;
        disciplineCoins++;

        saveUserData();
        updateCoinDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>å…‘æ¢æˆåŠŸï¼</strong>
              <br>æ¶ˆè€—é‡‘å¸: ${exchangeRate}
              <br>è·å¾—è‡ªå¾‹å¸: 1
              <br>å‰©ä½™é‡‘å¸: ${coins}
              <br>å½“å‰è‡ªå¾‹å¸: ${disciplineCoins}
            </div>
          `;

        showNotification("æˆåŠŸå…‘æ¢1æšè‡ªå¾‹å¸ï¼");
      }

      // å°†é’»çŸ³å…‘æ¢å›é‡‘å¸
      function convertDiamondsToCoins() {
        const exchangeRate = 900;
        if (diamonds < 1) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">é’»çŸ³ä¸è¶³ï¼éœ€è¦1é¢—é’»çŸ³è¿›è¡Œå…‘æ¢</p>`;
          return;
        }

        diamonds--;
        coins += exchangeRate;

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>å…‘æ¢æˆåŠŸï¼</strong>
              <br>æ¶ˆè€—é’»çŸ³: 1
              <br>è·å¾—é‡‘å¸: ${exchangeRate}
              <br>å‰©ä½™é‡‘å¸: ${coins}
              <br>å½“å‰é’»çŸ³: ${diamonds}
            </div>
          `;

        showNotification("æˆåŠŸå°†1é¢—é’»çŸ³å…‘æ¢ä¸º900é‡‘å¸ï¼");
      }

      // å°†è‡ªå¾‹å¸å…‘æ¢å›é‡‘å¸
      function convertDisciplineCoinsToCoins() {
        const exchangeRate = 25000;
        if (disciplineCoins < 1) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">è‡ªå¾‹å¸ä¸è¶³ï¼éœ€è¦1æšè‡ªå¾‹å¸è¿›è¡Œå…‘æ¢</p>`;
          return;
        }

        disciplineCoins--;
        coins += exchangeRate;

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>å…‘æ¢æˆåŠŸï¼</strong>
              <br>æ¶ˆè€—è‡ªå¾‹å¸: 1
              <br>è·å¾—é‡‘å¸: ${exchangeRate}
              <br>å‰©ä½™é‡‘å¸: ${coins}
              <br>å½“å‰è‡ªå¾‹å¸: ${disciplineCoins}
            </div>
          `;

        showNotification("æˆåŠŸå°†1æšè‡ªå¾‹å¸å…‘æ¢ä¸º25000é‡‘å¸ï¼");
      }

      function updateDiamondDisplay() {
        const diamondElements = document.querySelectorAll(
          "#diamondCount, #exchangeDiamondCount, #profileDiamonds, #headerDiamonds"
        );
        diamondElements.forEach((el) => (el.textContent = diamonds));

        // æ›´æ–°ä¿åº•æ˜¾ç¤º
        const guaranteeEl = document.getElementById("guaranteeCount");
        if (guaranteeEl) {
          guaranteeEl.textContent = lotteryCount;
        }

        const disciplineGuaranteeEl = document.getElementById(
          "disciplineGuaranteeCount"
        );
        if (disciplineGuaranteeEl) {
          disciplineGuaranteeEl.textContent = disciplineLotteryCount;
        }
      }

      function updateDisciplineCoinDisplay() {
        const disciplineCoinElements = document.querySelectorAll(
          "#profileDisciplineCoins, #disciplineCoinCount"
        );
        disciplineCoinElements.forEach(
          (el) => (el.textContent = disciplineCoins)
        );
      }

      // ç»Ÿä¸€ä¿å­˜ç”¨æˆ·æ•°æ®
      function saveUserData() {
        const users = JSON.parse(localStorage.getItem("users") || "{}");
        if (users[currentUser]) {
          users[currentUser].coins = coins;
          users[currentUser].diamonds = diamonds;
          users[currentUser].disciplineCoins = disciplineCoins;
          users[currentUser].lotteryCount = lotteryCount;
          users[currentUser].disciplineLotteryCount = disciplineLotteryCount;
          localStorage.setItem("users", JSON.stringify(users));
        }
      }

      // æ›´æ–°é‡‘å¸æ˜¾ç¤º
      function updateCoinDisplay() {
        const coinElements = document.querySelectorAll(
          "#headerCoins, #profileCoins"
        );
        coinElements.forEach((el) => (el.textContent = coins));
      }

      // å°†showNotificationå‡½æ•°é™„åŠ åˆ°windowå¯¹è±¡ï¼Œç¡®ä¿å…¨å±€å¯è®¿é—®
      window.showNotification = function (title, message) {
        // å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œåˆ™å°†å…¶ä½œä¸ºæ¶ˆæ¯ï¼Œæ ‡é¢˜é»˜è®¤ä¸ºç©º
        if (arguments.length === 1) {
          message = title;
          title = "";
        }

        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement("div");
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: fadeInOut 3s ease-in-out;
            font-weight: bold;
          `;

        // è®¾ç½®é€šçŸ¥å†…å®¹
        if (title) {
          notification.innerHTML = `<strong>${title}ï¼š</strong>${message}`;
        } else {
          notification.textContent = message;
        }

        document.body.appendChild(notification);

        // 3ç§’åç§»é™¤
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      };

      // ä¿æŒåŸå‡½æ•°åçš„å…¼å®¹æ€§
      function showNotification(title, message) {
        window.showNotification(title, message);
      }

      // æ˜¾ç¤ºç©ºç™½é¡µé¢
      function showEmptyPage(toolName) {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
        if (!emptyPageContainer || !emptyPageTitle) {
          console.warn("æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å…ƒç´ ");
          return;
        }

        // è®¾ç½®é¡µé¢æ ‡é¢˜å¹¶æ˜¾ç¤ºå®¹å™¨
        emptyPageTitle.textContent = toolName;
        emptyPageContainer.style.display = "block";

        console.log(`showEmptyPageè¢«è°ƒç”¨ï¼Œå·¥å…·å: ${toolName}`);

        // æ¸…é™¤å®¹å™¨å†…å®¹ï¼Œå‡†å¤‡æ·»åŠ æ–°å†…å®¹
        // å…ˆä¿å­˜æ ‡é¢˜å…ƒç´ 
        let titleElement = null;
        for (let i = 0; i < emptyPageContainer.children.length; i++) {
          if (emptyPageContainer.children[i].id === "emptyPageTitle") {
            titleElement = emptyPageContainer.children[i];
            break;
          }
        }

        // æ¸…ç©ºæ‰€æœ‰å­å…ƒç´ 
        emptyPageContainer.innerHTML = "";

        // é‡æ–°æ·»åŠ æ ‡é¢˜å…ƒç´ 
        if (titleElement) {
          emptyPageContainer.appendChild(titleElement);
        }

        // ç¡®ä¿æ ‡é¢˜æ˜¾ç¤ºæ­£ç¡®
        emptyPageTitle.textContent = toolName;

        // æ»šåŠ¨åˆ°ç©ºç™½é¡µé¢ä½ç½®
        emptyPageContainer.scrollIntoView({
          behavior: "smooth",
          block: "start",
        });

        // ä¸ºç‰¹å®šå·¥å…·æä¾›ç‰¹æ®Šå¤„ç†
        if (toolName === "ç•ªèŒ„é’Ÿ") {
          showTomatoClock();
        } else if (toolName === "é”æœº") {
          console.log("è°ƒç”¨initLockScreenå‡½æ•°");
          try {
            initLockScreen();
          } catch (error) {
            console.error("initLockScreenå‡½æ•°æ‰§è¡Œå¤±è´¥:", error);
            showNotification("é”™è¯¯", "é”æœºåŠŸèƒ½åŠ è½½å¤±è´¥");
          }
        } else if (toolName === "å±è”½ç½‘ç«™") {
          try {
            showWebsiteBlocker();
          } catch (error) {
            console.error("showWebsiteBlockerå‡½æ•°æ‰§è¡Œå¤±è´¥:", error);
            showNotification("é”™è¯¯", "å±è”½ç½‘ç«™åŠŸèƒ½åŠ è½½å¤±è´¥");
          }
        } else {
          // å¯¹äºå…¶ä»–å·¥å…·ï¼Œæ˜¾ç¤ºé»˜è®¤çš„å ä½ç¬¦
          const placeholder = document.createElement("div");
          // ä¸å†æ·»åŠ é»˜è®¤çš„"è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­"å ä½æ–‡æœ¬
          // emptyPageContainerç°åœ¨åªåŒ…å«emptyPageTitleå…ƒç´ 
        }
      }

      // ç•ªèŒ„é’ŸåŠŸèƒ½å®ç°
      function showTomatoClock() {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");

        // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
        if (!emptyPageContainer) {
          console.warn("æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å®¹å™¨");
          return;
        }

        // æ¸…ç©ºå®¹å™¨ï¼Œä¿ç•™æ ‡é¢˜å…ƒç´ 
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild.id === "emptyPageTitle") {
            break;
          }
          emptyPageContainer.removeChild(emptyPageContainer.firstChild);
        }

        // åˆ›å»ºç•ªèŒ„é’Ÿç•Œé¢
        const tomatoClockContainer = document.createElement("div");
        tomatoClockContainer.className = "tomato-clock-container";
        tomatoClockContainer.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          border-radius: 15px;
          padding: 2rem;
          margin: 1rem auto;
          max-width: 500px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        `;

        // ç•ªèŒ„é’ŸHTMLç»“æ„
        tomatoClockContainer.innerHTML = `
          <div id="tomatoClockSettings" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h4 style="color: var(--primary-color); margin: 0;">è®¾ç½®</h4>
              <button id="closeTomatoClock" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #666;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
              " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#666';">
                Ã—
              </button>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">ä¸“æ³¨æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" id="focusTime" min="1" max="120" value="25" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">ä¼‘æ¯æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" id="breakTime" min="1" max="60" value="5" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">é‡å¤æ¬¡æ•°</label>
                <input type="number" id="repeatCount" min="1" max="10" value="1" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">æç¤ºéŸ³</label>
                <select id="notificationSound" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
                  <option value="ding">æç¤ºéŸ³1</option>
                  <option value="beep">æç¤ºéŸ³2</option>
                  <option value="chime">æç¤ºéŸ³3</option>
                  <option value="upload">ä¸Šä¼ è‡ªå®šä¹‰</option>
                  <option value="none">é™éŸ³</option>
                </select>
                <input type="file" id="customSound" accept="audio/*" style="display: none;">
              </div>
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 2; min-width: 300px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">ä»»åŠ¡åç§°</label>
                <input type="text" id="taskName" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 2; min-width: 300px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">é¼“åŠ±è¯­</label>
                <textarea id="encouragementText" placeholder="è¯·è¾“å…¥é¼“åŠ±è¯­ï¼Œåœ¨ä¸“æ³¨è¿›è¡Œä¸­æ˜¾ç¤º" rows="2" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  resize: vertical;
                  outline: none;
                "></textarea>
              </div>
            </div>
          </div>
          
          <div id="tomatoClockDisplay" style="text-align: center; margin-bottom: 2rem;">
            <div id="taskNameDisplay" style="font-size: 1.2rem; font-weight: bold; color: #555; margin-bottom: 0.5rem;"></div>
            <div id="timeDisplay" style="font-size: 8rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.1); transition: all 0.3s ease;">25:00</div>
            <div id="encouragementDisplay" style="font-size: 1.1rem; color: #666; font-style: italic; margin-bottom: 0.5rem;"></div>
            <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">å‡†å¤‡å¼€å§‹ä¸“æ³¨</div>
            <div style="display: flex; justify-content: center; gap: 1rem;">
              <button id="startTomato" class="btn" style="background: var(--primary-color); color: white;">å¼€å§‹</button>
            </div>
            <div id="abandonIcon" style="display: none; font-size: 10rem; color: #f44336; margin-top: 1rem;">âœ—</div>
          </div>
        `;

        // æ·»åŠ åˆ°å®¹å™¨
        emptyPageContainer.appendChild(tomatoClockContainer);

        // åˆå§‹åŒ–ç•ªèŒ„é’Ÿ
        if (typeof initTomatoClock === "function") {
          initTomatoClock();
        } else {
          console.warn("initTomatoClockå‡½æ•°æœªå®šä¹‰ï¼Œä½†ç•ªèŒ„é’Ÿç•Œé¢å·²åŠ è½½å®Œæˆ");
        }
      }

      // é”æœºåŠŸèƒ½å®ç°
      function initLockScreen() {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å®¹å™¨");
          showNotification("é”™è¯¯", "æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å…ƒç´ ");
          return;
        }

        // æ¸…ç©ºå®¹å™¨ä½†ä¿ç•™æ ‡é¢˜å…ƒç´ 
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild !== emptyPageTitle) {
            emptyPageContainer.removeChild(emptyPageContainer.firstChild);
          } else {
            break;
          }
        }

        // åˆ›å»ºé”æœºç•Œé¢
        const lockScreenContainer = document.createElement("div");
        lockScreenContainer.className = "lock-screen-container";
        lockScreenContainer.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          border-radius: 15px;
          padding: 2rem;
          margin: 1rem auto;
          max-width: 600px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        `;

        // é”æœºHTMLç»“æ„
        lockScreenContainer.innerHTML = `
          <div style="margin-bottom: 2rem;">
            <h4 style="color: var(--primary-color); margin: 0 0 1.5rem 0;">é”æœºè®¾ç½®</h4>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 1; min-width: 200px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">é”æœºæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" id="lockDuration" min="1" max="180" value="30" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
              <div style="flex: 1; min-width: 200px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">è§£é”å¯†ç </label>
                <input type="password" id="lockPassword" placeholder="è®¾ç½®è§£é”å¯†ç " style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">ç™½åå•åº”ç”¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ chrome.exeï¼‰</label>
              <textarea id="whitelistApps" placeholder="
chrome.exe
code.exe
notepad.exe
" rows="6" style="
                width: 100%;
                padding: 0.7rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                font-family: monospace;
                resize: vertical;
                outline: none;
              "></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
              <button id="startLockScreen" class="btn" style="background: var(--primary-color); color: white; flex: 1;">å¼€å§‹é”æœº</button>
              <button id="saveWhitelist" class="btn" style="background: #6c757d; color: white; flex: 1;">ä¿å­˜ç™½åå•</button>
            </div>
          </div>
          
          <div style="text-align: center; margin-bottom: 2rem;">
            <div id="lockStatus" style="font-size: 1.2rem; color: #666; margin-bottom: 1rem;">æœªé”æœº</div>
            <div id="lockCountdown" style="display: none; font-size: 4rem; font-weight: bold; color: var(--primary-color); margin-bottom: 1rem;">00:00</div>
            <div id="allowedApps" style="display: none; margin-top: 1rem;">
              <h5 style="color: #666; margin: 0 0 0.5rem 0;">å…è®¸è¿è¡Œçš„åº”ç”¨ï¼š</h5>
              <div id="allowedAppsList" style="text-align: left; font-family: monospace; font-size: 0.9rem; color: #555;"></div>
            </div>
          </div>
        `;

        // æ·»åŠ åˆ°å®¹å™¨
        emptyPageContainer.appendChild(lockScreenContainer);

        // åŠ è½½ä¿å­˜çš„ç™½åå•
        const savedWhitelist = localStorage.getItem("lockScreenWhitelist");
        if (savedWhitelist) {
          document.getElementById("whitelistApps").value = savedWhitelist;
        }

        // æ›´æ–°å…è®¸åº”ç”¨åˆ—è¡¨æ˜¾ç¤º
        updateAllowedAppsList();

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document
          .getElementById("startLockScreen")
          .addEventListener("click", startLockScreen);
        document
          .getElementById("saveWhitelist")
          .addEventListener("click", saveWhitelist);

        // ä¿å­˜ç™½åå•å‡½æ•°
        function saveWhitelist() {
          const whitelistApps = document.getElementById("whitelistApps").value;
          localStorage.setItem("lockScreenWhitelist", whitelistApps);
          updateAllowedAppsList();
          showNotification("æˆåŠŸ", "ç™½åå•å·²ä¿å­˜");
        }

        // æ›´æ–°å…è®¸åº”ç”¨åˆ—è¡¨æ˜¾ç¤º
        function updateAllowedAppsList() {
          const whitelistApps = document.getElementById("whitelistApps").value;
          const allowedAppsList = document.getElementById("allowedAppsList");
          const allowedAppsDiv = document.getElementById("allowedApps");

          if (whitelistApps.trim() === "") {
            allowedAppsDiv.style.display = "none";
            return;
          }

          allowedAppsDiv.style.display = "block";
          const apps = whitelistApps
            .split("\n")
            .filter((app) => app.trim() !== "");
          allowedAppsList.innerHTML = "";

          apps.forEach((app) => {
            const appItem = document.createElement("div");
            appItem.style.cssText = `
              padding: 0.2rem 0;
              border-bottom: 1px solid #eee;
            `;
            appItem.textContent = app.trim();
            allowedAppsList.appendChild(appItem);
          });
        }

        // å¼€å§‹é”æœºå‡½æ•°
        function startLockScreen() {
          console.log("å¼€å§‹é”æœºå‡½æ•°è¢«è°ƒç”¨");

          // ç¡®ä¿æ‰€æœ‰éœ€è¦çš„å…ƒç´ éƒ½å­˜åœ¨
          const lockDuration = document.getElementById("lockDuration");
          const lockPassword = document.getElementById("lockPassword");
          const whitelistApps = document.getElementById("whitelistApps");
          const lockStatus = document.getElementById("lockStatus");
          const lockCountdown = document.getElementById("lockCountdown");

          if (
            !lockDuration ||
            !lockPassword ||
            !whitelistApps ||
            !lockStatus ||
            !lockCountdown
          ) {
            console.error("é”æœºç›¸å…³å…ƒç´ æœªæ‰¾åˆ°");
            showNotification("é”™è¯¯", "é”æœºåŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            return;
          }

          const duration = parseInt(lockDuration.value) || 30;
          const password = lockPassword.value;
          const whitelistAppsValue = whitelistApps.value;

          // éªŒè¯è¾“å…¥
          if (duration < 1 || duration > 180) {
            showNotification("é”™è¯¯", "é”æœºæ—¶é•¿åº”åœ¨1-180åˆ†é’Ÿä¹‹é—´");
            return;
          }

          if (password.length < 4) {
            showNotification("é”™è¯¯", "å¯†ç é•¿åº¦è‡³å°‘ä¸º4ä½");
            return;
          }

          // ä¿å­˜è®¾ç½®
          localStorage.setItem(
            "lockScreenSettings",
            JSON.stringify({
              duration: duration,
              password: password,
              whitelistApps: whitelistAppsValue,
            })
          );

          // æ˜¾ç¤ºé”æœºçŠ¶æ€
          lockStatus.textContent = "å·²é”æœº";
          lockCountdown.style.display = "block";

          // è®¡ç®—ç»“æŸæ—¶é—´
          const endTime = new Date().getTime() + duration * 60 * 1000;
          localStorage.setItem("lockScreenEndTime", endTime);

          // å¼€å§‹å€’è®¡æ—¶
          updateCountdown();
          const countdownInterval = setInterval(updateCountdown, 1000);

          // æ˜¾ç¤ºé”æœºè­¦å‘Š
          showNotification(
            "æç¤º",
            `ç”µè„‘å°†åœ¨${duration}åˆ†é’Ÿåè§£é”ï¼Œç™½åå•åº”ç”¨å¯æ­£å¸¸ä½¿ç”¨`
          );

          // å¯åŠ¨é”æœºç›‘æ§ï¼ˆæ³¨æ„ï¼šè¿™åªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…ç›‘æ§éœ€è¦åç«¯æ”¯æŒï¼‰
          const lockMonitorInterval = setInterval(monitorRunningApps, 5000);

          console.log("å°è¯•æ˜¾ç¤ºè§£é”ç•Œé¢");
          // ç«‹å³æ˜¾ç¤ºå…¨å±é”ç•Œé¢
          setTimeout(() => {
            if (window.showUnlockScreen) {
              console.log("è°ƒç”¨window.showUnlockScreen()");
              window.showUnlockScreen();
            } else {
              console.error("window.showUnlockScreen() å‡½æ•°æœªå®šä¹‰");
            }
          }, 1000);

          // å€’è®¡æ—¶æ›´æ–°å‡½æ•°
          function updateCountdown() {
            const now = new Date().getTime();
            const timeLeft = endTime - now;

            if (timeLeft <= 0) {
              clearInterval(countdownInterval);
              clearInterval(lockMonitorInterval);
              document.getElementById("lockStatus").textContent = "å·²è§£é”";
              document.getElementById("lockCountdown").style.display = "none";
              localStorage.removeItem("lockScreenEndTime");
              showNotification("å®Œæˆ", "ç”µè„‘å·²è§£é”");
              return;
            }

            const minutes = Math.floor(
              (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById("lockCountdown").textContent = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          }

          // ç›‘æ§è¿è¡Œåº”ç”¨å‡½æ•°ï¼ˆæ¨¡æ‹Ÿï¼‰
          function monitorRunningApps() {
            // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™éœ€è¦ä½¿ç”¨Windows APIæˆ–å…¶ä»–ç³»ç»Ÿçº§API
            // è¿™é‡Œæˆ‘ä»¬åªæ˜¯æ¨¡æ‹Ÿæ£€æŸ¥
            console.log("ç›‘æ§è¿è¡Œä¸­çš„åº”ç”¨...");
            // åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯è„šæœ¬æ¥æ£€æŸ¥è¿è¡Œçš„è¿›ç¨‹
            // å¹¶ä¸ç™½åå•è¿›è¡Œå¯¹æ¯”
          }
        }
      }

      // æ˜¾ç¤ºé€šçŸ¥å‡½æ•°
      function showNotification(title, message) {
        // è·å–è®¾ç½®åŒºåŸŸä¸‹æ–¹çš„ä½ç½®
        const settingsContainer =
          document.getElementById("tomatoClockSettings") || document.body;
        const notificationPosition = settingsContainer.getBoundingClientRect();

        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement("div");
        notification.style.cssText = `
            position: fixed;
            left: 50%;
            top: ${notificationPosition.bottom + 10}px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
          `;

        // æ ¹æ®æ ‡é¢˜å†³å®šæ˜¾ç¤ºå¯¹å·è¿˜æ˜¯å…¶ä»–å›¾æ ‡
        const icon =
          title.includes("å®Œæˆ") || title.includes("æˆåŠŸ")
            ? "âœ…"
            : title.includes("ç»“æŸ")
            ? "ğŸ””"
            : "â“";

        notification.innerHTML = `
            <div style="font-size: 1.5rem;">${icon}</div>
            <div>
              <h4 style="margin: 0 0 5px 0;">${title}</h4>
              <p style="margin: 0; font-size: 0.9rem;">${message}</p>
            </div>
          `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);

        // æ˜¾ç¤ºé€šçŸ¥
        setTimeout(() => {
          notification.style.opacity = "1";
        }, 10);

        // 3ç§’åéšè—é€šçŸ¥
        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // ç•ªèŒ„é’Ÿæ ¸å¿ƒé€»è¾‘
      function initTomatoClock() {
        // è·å–å…ƒç´ å¼•ç”¨å¹¶è®¾ç½®ä¸ºå…¨å±€å˜é‡
        window.focusTimeInput = document.getElementById("focusTime") || {
          value: 25,
        };
        window.breakTimeInput = document.getElementById("breakTime") || {
          value: 5,
        };
        window.repeatCountInput = document.getElementById("repeatCount") || {
          value: 1,
        };
        window.notificationSoundSelect = document.getElementById(
          "notificationSound"
        ) || { value: "ding" };
        window.customSoundInput = document.getElementById("customSound") || {};
        window.taskNameInput = document.getElementById("taskName") || {
          value: "",
        };
        window.encouragementTextInput = document.getElementById(
          "encouragementText"
        ) || { value: "ä½ åšå¾—å¾ˆæ£’ï¼ç»§ç»­ä¿æŒï¼" };
        window.taskNameDisplay =
          document.getElementById("taskNameDisplay") ||
          document.createElement("div");
        window.encouragementDisplay =
          document.getElementById("encouragementDisplay") ||
          document.createElement("div");
        window.timeDisplay =
          document.querySelector("#tomatoClockDisplay > div:nth-child(2)") ||
          document.createElement("div");
        window.statusDisplay =
          document.querySelector("#tomatoClockDisplay > div:nth-child(3)") ||
          document.createElement("div");
        window.startButton =
          document.getElementById("startTomato") ||
          document.createElement("button");
        window.settingsContainer =
          document.getElementById("tomatoClockSettings") ||
          document.createElement("div");
        window.abandonIcon =
          document.getElementById("abandonIcon") ||
          document.createElement("div");

        // å…ˆå®šä¹‰å˜é‡ï¼Œå†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        let timerInterval = null;
        let currentTime = 0;
        let totalTime = 0;
        let isFocusMode = true;
        let isPaused = false;
        let notificationSound = "ding";
        let customSound = null;
        let taskName = "";
        let encouragementText = "ä½ åšå¾—å¾ˆæ£’ï¼ç»§ç»­ä¿æŒï¼";

        // åˆ›å»ºé»˜è®¤å£°éŸ³å…ƒç´ 
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();

        // ä¸ºæ—¶é—´è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œå®æ—¶æ›´æ–°æ—¶é—´æ˜¾ç¤º
        if (window.focusTimeInput && window.timeDisplay) {
          window.focusTimeInput.addEventListener("input", function () {
            // å…è®¸è¾“å…¥æ¡†ä¸ºç©ºï¼Œåªæœ‰åœ¨æœ‰å€¼æ—¶æ‰éªŒè¯èŒƒå›´
            if (window.focusTimeInput.value.trim() !== "") {
              const value = parseInt(window.focusTimeInput.value) || 25;
              const validValue = Math.max(1, Math.min(120, value));
              window.focusTimeInput.value = validValue;
            }

            // åªæœ‰åœ¨ç•ªèŒ„é’Ÿæœªå¼€å§‹æ—¶æ‰æ›´æ–°æ˜¾ç¤º
            if (!timerInterval) {
              const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
              window.timeDisplay.textContent = formatTime(focusMinutes * 60);
            }
          });
        }

        if (window.breakTimeInput && window.timeDisplay) {
          window.breakTimeInput.addEventListener("input", function () {
            // å…è®¸è¾“å…¥æ¡†ä¸ºç©ºï¼Œåªæœ‰åœ¨æœ‰å€¼æ—¶æ‰éªŒè¯èŒƒå›´
            if (window.breakTimeInput.value.trim() !== "") {
              const value = parseInt(window.breakTimeInput.value) || 5;
              const validValue = Math.max(1, Math.min(60, value));
              window.breakTimeInput.value = validValue;
            }
          });
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, "0")}:${secs
            .toString()
            .padStart(2, "0")}`;
        }

        // æ’­æ”¾æç¤ºéŸ³
        function playNotificationSound() {
          if (notificationSound === "none") return;

          try {
            // ç®€å•çš„å£°éŸ³åˆæˆå‡½æ•°
            function generateSound(type) {
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();

              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);

              switch (type) {
                case "ding":
                  oscillator.type = "sine";
                  oscillator.frequency.setValueAtTime(
                    880,
                    audioContext.currentTime
                  );
                  oscillator.frequency.exponentialRampToValueAtTime(
                    440,
                    audioContext.currentTime + 0.5
                  );
                  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 1.5
                  );
                  oscillator.start();
                  oscillator.stop(audioContext.currentTime + 1.5);
                  break;
                case "beep":
                  oscillator.type = "square";
                  oscillator.frequency.setValueAtTime(
                    1000,
                    audioContext.currentTime
                  );
                  gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 0.5
                  );
                  oscillator.start();
                  oscillator.stop(audioContext.currentTime + 0.5);

                  // ç¬¬äºŒå£°
                  setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.type = "square";
                    osc2.frequency.setValueAtTime(
                      800,
                      audioContext.currentTime
                    );
                    gain2.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(
                      0.01,
                      audioContext.currentTime + 0.5
                    );
                    osc2.start();
                    osc2.stop(audioContext.currentTime + 0.5);
                  }, 300);
                  break;
                case "chime":
                  oscillator.type = "sine";
                  oscillator.frequency.setValueAtTime(
                    523.25,
                    audioContext.currentTime
                  ); // C5
                  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 2
                  );

                  // æ·»åŠ è°æ³¢
                  const osc2 = audioContext.createOscillator();
                  const gain2 = audioContext.createGain();
                  osc2.connect(gain2);
                  gain2.connect(audioContext.destination);
                  osc2.type = "sine";
                  osc2.frequency.setValueAtTime(
                    783.99,
                    audioContext.currentTime
                  ); // G5
                  gain2.gain.setValueAtTime(0.15, audioContext.currentTime);
                  gain2.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 2
                  );

                  oscillator.start();
                  osc2.start();
                  oscillator.stop(audioContext.currentTime + 2);
                  osc2.stop(audioContext.currentTime + 2);
                  break;
              }
            }

            // æ’­æ”¾å†…ç½®å£°éŸ³æˆ–è‡ªå®šä¹‰å£°éŸ³
            if (notificationSound === "upload" && customSound) {
              const audio = new Audio(URL.createObjectURL(customSound));
              audio.play();
            } else {
              generateSound(notificationSound);
            }
          } catch (e) {
            console.error("æ’­æ”¾å£°éŸ³å¤±è´¥:", e);
          }
        }

        // å¼€å§‹ç•ªèŒ„é’Ÿ
        function startTomatoClock() {
          // è·å–è®¾ç½®å€¼ï¼Œç¡®ä¿å½“ä¸“æ³¨æ—¶é—´è¾“å…¥æ¡†ä¸ºç©ºæ—¶é»˜è®¤ä½¿ç”¨25åˆ†é’Ÿ
          const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
          const breakMinutes = parseInt(window.breakTimeInput.value) || 5;
          repeatCount = parseInt(window.repeatCountInput.value) || 1;
          notificationSound = window.notificationSoundSelect.value;
          taskName = window.taskNameInput.value || "";
          encouragementText =
            window.encouragementTextInput.value || "ä½ åšå¾—å¾ˆæ£’ï¼ç»§ç»­ä¿æŒï¼";

          // åˆå§‹åŒ–
          isFocusMode = true;
          currentRepeat = 0;
          currentTime = focusMinutes * 60;
          totalTime = currentTime;

          // æ›´æ–°æ˜¾ç¤º
          if (window.timeDisplay)
            window.timeDisplay.textContent = formatTime(currentTime);
          // çŠ¶æ€æ–‡æœ¬ä¸é‚£ä¹ˆçªå‡º
          if (window.statusDisplay)
            window.statusDisplay.textContent = "ä¸“æ³¨ä¸­...";
          if (window.taskNameDisplay)
            window.taskNameDisplay.textContent = taskName
              ? `æ­£åœ¨ä¸“æ³¨ï¼š${taskName}`
              : "";
          if (window.abandonIcon) window.abandonIcon.style.display = "none";
          if (window.encouragementDisplay)
            window.encouragementDisplay.textContent = encouragementText;

          // å·²ç§»é™¤è¿›åº¦ç‚¹åŠŸèƒ½

          // éšè—è®¾ç½®
          window.settingsContainer.style.display = "none";

          // æ›´æ–°æŒ‰é’®
          window.startButton.textContent = "æš‚åœ";

          // æ·»åŠ æ§åˆ¶æŒ‰é’®
          if (document.getElementById("resumeTomato")) return;

          const controlsDiv = startButton && startButton.parentElement;
          if (!controlsDiv) return;

          controlsDiv.innerHTML = "";

          const pauseButton = document.createElement("button");
          pauseButton.id = "pauseTomato";
          pauseButton.className = "btn";
          pauseButton.style.backgroundColor = "#ff9800";
          pauseButton.style.color = "white";
          pauseButton.textContent = "æš‚åœ";
          pauseButton.onclick = pauseTomatoClock;

          const resetButton = document.createElement("button");
          resetButton.id = "resetTomato";
          resetButton.className = "btn";
          resetButton.style.backgroundColor = "#f44336";
          resetButton.style.color = "white";
          resetButton.textContent = "æ”¾å¼ƒ";
          resetButton.onclick = resetTomatoClock;

          controlsDiv.appendChild(pauseButton);
          controlsDiv.appendChild(resetButton);

          // å¼€å§‹è®¡æ—¶
          if (timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(updateTomatoClock, 1000);
        }

        // æš‚åœç•ªèŒ„é’Ÿ
        function pauseTomatoClock() {
          if (isPaused) {
            // æ¢å¤
            if (!timerInterval) {
              timerInterval = setInterval(updateTomatoClock, 1000);
            }
            document.getElementById("pauseTomato").textContent = "æš‚åœ";
            // çŠ¶æ€æ–‡æœ¬ä¸é‚£ä¹ˆçªå‡º
            window.statusDisplay.textContent = isFocusMode
              ? "ä¸“æ³¨ä¸­..."
              : "ä¼‘æ¯ä¸­...";
            // æ¢å¤æ—¶ï¼Œå¦‚æœæ˜¯ä¸“æ³¨æ¨¡å¼åˆ™æ˜¾ç¤ºé¼“åŠ±è¯­
            if (isFocusMode && window.encouragementDisplay) {
              window.encouragementDisplay.textContent = encouragementText;
            }
          } else {
            // æš‚åœ
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }
            document.getElementById("pauseTomato").textContent = "ç»§ç»­";
            // çŠ¶æ€æ–‡æœ¬ä¸é‚£ä¹ˆçªå‡º
            statusDisplay.textContent = "å·²æš‚åœä¸“æ³¨";
            // æš‚åœæ—¶æ¸…ç©ºé¼“åŠ±è¯­
            if (encouragementDisplay) {
              encouragementDisplay.textContent = "";
            }
          }
          isPaused = !isPaused;
        }

        // é‡ç½®ç•ªèŒ„é’Ÿ
        function resetTomatoClock() {
          clearInterval(timerInterval);
          timerInterval = null;
          isPaused = false;

          // æ˜¾ç¤ºè®¾ç½®
          window.settingsContainer.style.display = "block";

          // æ›´æ–°æ˜¾ç¤º
          const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
          if (window.timeDisplay)
            window.timeDisplay.textContent = formatTime(focusMinutes * 60);
          // çŠ¶æ€æ–‡æœ¬ä¸é‚£ä¹ˆçªå‡º
          if (window.statusDisplay)
            window.statusDisplay.textContent = "å‡†å¤‡å¼€å§‹ä¸“æ³¨...";
          if (window.taskNameDisplay) window.taskNameDisplay.textContent = "";
          if (window.encouragementDisplay)
            window.encouragementDisplay.textContent = "";

          // ä½¿ç”¨ä¸å®Œæˆä»»åŠ¡ç›¸åŒçš„æ–¹å¼æ˜¾ç¤ºå‰å·å›¾æ ‡
          const abandonIcon = document.createElement("div");
          abandonIcon.style.cssText = `
            position: fixed;
            left: 50%;
            top: 30%;
            transform: translateX(-50%);
            font-size: 8rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
          `;
          abandonIcon.textContent = "âœ—";
          document.body.appendChild(abandonIcon);

          setTimeout(() => {
            abandonIcon.style.opacity = "1";
          }, 10);

          // 3ç§’åéšè—å›¾æ ‡
          setTimeout(() => {
            abandonIcon.style.opacity = "0";
            setTimeout(() => {
              if (document.body.contains(abandonIcon)) {
                document.body.removeChild(abandonIcon);
              }
            }, 300);
          }, 2500);

          // æ›´æ–°æŒ‰é’®
          const controlsDiv =
            document.getElementById("pauseTomato").parentElement;
          controlsDiv.innerHTML = "";

          const startButton = document.createElement("button");
          startButton.id = "startTomato";
          startButton.className = "btn";
          startButton.style.backgroundColor = "var(--primary-color)";
          startButton.style.color = "white";
          startButton.textContent = "å¼€å§‹";
          startButton.onclick = startTomatoClock;

          controlsDiv.appendChild(startButton);
        }

        // æ›´æ–°ç•ªèŒ„é’Ÿ
        function updateTomatoClock() {
          if (currentTime <= 0) {
            // æ¸…é™¤å®šæ—¶å™¨
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }

            // æ’­æ”¾æç¤ºéŸ³
            playNotificationSound();

            // æ˜¾ç¤ºé€šçŸ¥
            if (isFocusMode) {
              showNotification("ä¸“æ³¨æ—¶é—´ç»“æŸï¼", encouragementText);
            } else {
              showNotification("ä¼‘æ¯æ—¶é—´ç»“æŸï¼", "å‡†å¤‡å¼€å§‹ä¸‹ä¸€ä¸ªä¸“æ³¨æ—¶æ®µ");
            }

            if (isFocusMode) {
              // ä¸“æ³¨æ—¶é—´ç»“æŸ
              // æ‰€æœ‰é‡å¤å®Œæˆ
              window.statusDisplay.textContent = "ä¸“æ³¨æ—¶é—´å·²å®Œæˆï¼";

              // åœ¨è®¾ç½®ä¸‹æ–¹æ˜¾ç¤ºå®Œæˆå›¾æ ‡
              const completionIcon = document.createElement("div");
              completionIcon.style.cssText = `
                  position: fixed;
                  left: 50%;
                  top: 30%;
                  transform: translateX(-50%);
                  font-size: 8rem;
                  z-index: 1000;
                  opacity: 0;
                  transition: opacity 0.3s ease;
                `;
              completionIcon.textContent = "âœ…";
              document.body.appendChild(completionIcon);

              setTimeout(() => {
                completionIcon.style.opacity = "1";
              }, 10);

              // 3ç§’åéšè—å›¾æ ‡ï¼Œä¸å†è‡ªåŠ¨é‡ç½®ç•ªèŒ„é’Ÿï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
              setTimeout(() => {
                completionIcon.style.opacity = "0";
                setTimeout(() => {
                  if (document.body.contains(completionIcon)) {
                    document.body.removeChild(completionIcon);
                  }
                }, 300);
              }, 2500);
            } else {
              // ä¼‘æ¯æ—¶é—´ç»“æŸ
              isFocusMode = true;
              const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
              currentTime = focusMinutes * 60;
              totalTime = currentTime;

              // æ›´æ–°æ˜¾ç¤º
              if (window.timeDisplay)
                window.timeDisplay.textContent = formatTime(currentTime);
              // çŠ¶æ€æ–‡æœ¬ä¸é‚£ä¹ˆçªå‡º
              if (window.statusDisplay)
                window.statusDisplay.textContent = "ä¸“æ³¨ä¸­...";
              if (window.taskNameDisplay)
                window.taskNameDisplay.textContent = taskName
                  ? `æ­£åœ¨ä¸“æ³¨ï¼š${taskName}`
                  : "";
              if (window.encouragementDisplay)
                window.encouragementDisplay.textContent = encouragementText;

              // å¼€å§‹ä¸“æ³¨è®¡æ—¶ - ç¡®ä¿ä¸ä¼šé‡å¤è®¾ç½®å®šæ—¶å™¨
              if (!timerInterval) {
                timerInterval = setInterval(updateTomatoClock, 1000);
              }
            }
          } else {
            // æ›´æ–°å€’è®¡æ—¶
            currentTime--;
            timeDisplay.textContent = formatTime(currentTime);
          }
        }

        // ç»‘å®šå¼€å§‹æŒ‰é’®äº‹ä»¶
        if (startButton && !startButton.hasEventListener) {
          startButton.addEventListener("click", startTomatoClock);
          startButton.hasEventListener = true;
        }

        // ç»‘å®šå£°éŸ³é€‰æ‹©äº‹ä»¶
        notificationSoundSelect.addEventListener("change", function () {
          if (this.value === "upload") {
            customSoundInput.click();
          }
        });

        // ç»‘å®šè‡ªå®šä¹‰å£°éŸ³ä¸Šä¼ äº‹ä»¶
        customSoundInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            customSound = this.files[0];
          }
        });

        // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
        const closeButton = document.getElementById("closeTomatoClock");
        if (closeButton && !closeButton.hasEventListener) {
          closeButton.addEventListener("click", function () {
            const emptyPageContainer =
              document.getElementById("emptyPageContainer");
            if (emptyPageContainer) {
              emptyPageContainer.style.display = "none";
            }
          });
          closeButton.hasEventListener = true;
        }
      }

      function checkDailyTaskReward() {
        const today = new Date().toDateString();
        const userData = JSON.parse(localStorage.getItem("users") || "{}");
        const currentUser = localStorage.getItem("currentUser");

        if (!currentUser || !userData[currentUser]) return;

        const user = userData[currentUser];

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©
        if (user.lastDailyChallenge !== today) {
          user.dailyCompletedTasks = 0;
          user.dailyRewards = [];
          user.lastDailyChallenge = today;
        }

        const completedTasks = user.dailyCompletedTasks || 0;

        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ–°çš„é‡Œç¨‹ç¢‘
        if (completedTasks < 4) {
          // æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡å¥–åŠ±10é‡‘å¸
          user.dailyRewards = user.dailyRewards || [];
          user.dailyRewards.push({
            description: `å®Œæˆç¬¬${completedTasks}ä¸ªä»£åŠä»»åŠ¡å¥–åŠ±`,
            amount: 10,
          });
        } else if (completedTasks === 4) {
          // å®Œæˆ4ä¸ªä»»åŠ¡é¢å¤–å¥–åŠ±20é‡‘å¸
          user.dailyRewards = user.dailyRewards || [];
          user.dailyRewards.push({
            description: `å®Œæˆ4ä¸ªä»£åŠä»»åŠ¡é¢å¤–å¥–åŠ±`,
            amount: 20,
          });
        }

        saveUserData();
      }

      // ç¤¼åŒ…ç å…‘æ¢åŠŸèƒ½
      function redeemGiftCode() {
        const code = document.getElementById("giftCodeInput").value.trim();
        const resultDiv = document.getElementById("giftCodeResult");

        if (!code) {
          resultDiv.innerHTML = '<p style="color: #ff6b6b;">è¯·è¾“å…¥ç¤¼åŒ…ç </p>';
          return;
        }

        // æ£€æŸ¥ç¤¼åŒ…ç æ˜¯å¦å·²ä½¿ç”¨
        const usedCodes = JSON.parse(
          localStorage.getItem(`usedCodes_${currentUser}`) || "[]"
        );
        if (usedCodes.includes(code)) {
          resultDiv.innerHTML = '<p style="color: #ff6b6b;">è¯¥ç¤¼åŒ…ç å·²ä½¿ç”¨</p>';
          return;
        }

        // ç¤¼åŒ…ç é…ç½®
        const giftCodes = {
          nick20090120: 10000000, // 1000ä¸‡é‡‘å¸
          zhengzihan: 10000000, // 1000ä¸‡é‡‘å¸
          "370303200901208518": 10000000, // 1000ä¸‡é‡‘å¸
        };

        if (giftCodes[code]) {
          const reward = giftCodes[code];
          coins += reward;

          // ä¿å­˜ç”¨æˆ·æ•°æ®
          saveUserData();

          // æ ‡è®°ç¤¼åŒ…ç ä¸ºå·²ä½¿ç”¨
          usedCodes.push(code);
          localStorage.setItem(
            `usedCodes_${currentUser}`,
            JSON.stringify(usedCodes)
          );

          // æ›´æ–°æ˜¾ç¤º
          updateCoinDisplay();
          updateDiamondDisplay();

          // æ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶è‡ªåŠ¨æ¶ˆå¤±
          resultDiv.innerHTML = `<p style="color: #4ecdc4; font-weight: bold; animation: fadeInOut 3s ease-in-out;">âœ… å…‘æ¢æˆåŠŸï¼è·å¾— ${reward.toLocaleString()} é‡‘å¸ï¼</p>`;
          document.getElementById("giftCodeInput").value = "";

          // 3ç§’åæ¸…é™¤æç¤º
          setTimeout(() => {
            resultDiv.innerHTML = "";
          }, 3000);
        } else {
          resultDiv.innerHTML =
            '<p style="color: #ff6b6b; animation: shake 0.5s ease-in-out;">æ— æ•ˆçš„ç¤¼åŒ…ç </p>';
          setTimeout(() => {
            resultDiv.innerHTML = "";
          }, 2000);
        }
      }

      function initApp() {
        const savedUser = localStorage.getItem("currentUser");
        if (savedUser) {
          currentUser = savedUser;
          showMainApp();
        } else {
          showWelcome();
        }
      }

      // æ§åˆ¶+æŒ‰é’®åœ¨ä»£åŠç•Œé¢æ˜¾ç¤º
      function toggleAddTodoButton() {
        const todoSection = document.getElementById("todoSection");
        const addTodoBtn = document.getElementById("addTodoBtn");

        // åªåœ¨ä»£åŠç•Œé¢æ˜¾ç¤º+æŒ‰é’®
        if (todoSection.classList.contains("active")) {
          addTodoBtn.style.opacity = "1";
          addTodoBtn.style.visibility = "visible";
        } else {
          addTodoBtn.style.opacity = "0";
          addTodoBtn.style.visibility = "hidden";
        }
      }

      // è·³è¿‡æ¬¢è¿åŠ¨ç”»
      function skipWelcomeAnimation() {
        // æ¸…é™¤è‡ªåŠ¨éšè—çš„å®šæ—¶å™¨
        if (window.welcomeTimeout) {
          clearTimeout(window.welcomeTimeout);
          window.welcomeTimeout = null;
        }
        // ç«‹å³éšè—æ¬¢è¿ç•Œé¢
        hideWelcome();
      }

      // æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
      function showWelcome() {
        const welcomeScreen = document.getElementById("welcomeScreen");
        welcomeScreen.style.display = "flex";
        welcomeScreen.style.opacity = "0";

        setTimeout(() => {
          welcomeScreen.style.opacity = "1";
        }, 100);

        // 2ç§’åè‡ªåŠ¨éšè—æ¬¢è¿ç•Œé¢
        window.welcomeTimeout = setTimeout(() => {
          hideWelcome();
        }, 2000);
      }

      function hideWelcome() {
        const welcomeScreen = document.getElementById("welcomeScreen");
        welcomeScreen.style.opacity = "0";

        setTimeout(() => {
          welcomeScreen.style.display = "none";
          showLogin();
        }, 800);
      }

      // æ˜¾ç¤ºç™»å½•ç•Œé¢
      function showLogin() {
        const loginScreen = document.getElementById("loginScreen");
        loginScreen.style.display = "flex";
        loginScreen.style.opacity = "0";

        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•ä¿¡æ¯
        const rememberedUsername = localStorage.getItem("rememberedUsername");
        const rememberedPassword = localStorage.getItem("rememberedPassword");
        const rememberMe = localStorage.getItem("rememberMe") === "true";

        // è®¾ç½®è®°ä½æˆ‘å¤é€‰æ¡†çŠ¶æ€
        document.getElementById("rememberMe").checked = rememberMe;

        // å¦‚æœæœ‰è®°ä½çš„è´¦å·ä¸”ç”¨æˆ·é€‰æ‹©äº†è®°ä½æˆ‘ï¼Œåˆ™è‡ªåŠ¨å¡«å†™
        if (rememberedUsername && rememberedPassword && rememberMe) {
          document.getElementById("username").value = rememberedUsername;
          document.getElementById("password").value = rememberedPassword;
        } else if (rememberedUsername && rememberedPassword) {
          // å¦‚æœæœ‰è®°ä½çš„è´¦å·ä½†æœªé€‰æ‹©è®°ä½æˆ‘ï¼Œåˆ™è¯¢é—®æ˜¯å¦è‡ªåŠ¨å¡«å†™
          if (
            confirm(
              `æ£€æµ‹åˆ°å·²ä¿å­˜çš„è´¦å· ${rememberedUsername}ï¼Œæ˜¯å¦è‡ªåŠ¨å¡«å†™ç™»å½•ä¿¡æ¯ï¼Ÿ`
            )
          ) {
            document.getElementById("username").value = rememberedUsername;
            document.getElementById("password").value = rememberedPassword;
          }
        }

        setTimeout(() => {
          loginScreen.style.opacity = "1";
        }, 100);
      }

      // æ˜¾ç¤ºä¸»ç•Œé¢
      function showMainApp() {
        const mainApp = document.getElementById("mainApp");
        const loginScreen = document.getElementById("loginScreen");
        const welcomeScreen = document.getElementById("welcomeScreen");

        welcomeScreen.style.display = "none";
        loginScreen.style.display = "none";

        mainApp.style.display = "block";
        mainApp.style.opacity = "0";

        setTimeout(() => {
          mainApp.style.opacity = "1";
        }, 100);

        updateProfileInfo();
        loadTodos();
        switchTab("todo");
        // ç¡®ä¿åˆå§‹æ¸²æŸ“
        setTimeout(() => {
          renderTodos();
        }, 200);
      }

      // ç™»å½•/æ³¨å†Œåˆ‡æ¢
      document
        .getElementById("toggleLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          isLoginMode = !isLoginMode;

          const title = document.getElementById("authTitle");
          const button = document.getElementById("authButton");
          const toggleText = document.getElementById("toggleText");
          const toggleLink = document.getElementById("toggleLink");

          if (isLoginMode) {
            title.textContent = "æ¬¢è¿å›æ¥";
            button.textContent = "ç™»å½•";
            toggleText.textContent = "è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ";
            toggleLink.textContent = "ç«‹å³æ³¨å†Œ";
          } else {
            title.textContent = "åˆ›å»ºè´¦å·";
            button.textContent = "æ³¨å†Œ";
            toggleText.textContent = "å·²æœ‰è´¦å·ï¼Ÿ";
            toggleLink.textContent = "ç«‹å³ç™»å½•";
          }
        });

      // è¡¨å•æäº¤
      document
        .getElementById("authForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;

          if (isLoginMode) {
            login(username, password);
          } else {
            register(username, password);
          }
        });

      // ç™»å½•
      function login(username, password) {
        const users = JSON.parse(localStorage.getItem("users") || "{}");

        if (!users[username]) {
          alert("ç”¨æˆ·ä¸å­˜åœ¨ï¼");
          return;
        }

        if (users[username].password !== password) {
          alert("å¯†ç é”™è¯¯ï¼");
          return;
        }

        currentUser = username;
        localStorage.setItem("currentUser", username);

        // æ ¹æ®è®°ä½æˆ‘å¤é€‰æ¡†çš„çŠ¶æ€æ¥å†³å®šæ˜¯å¦ä¿å­˜ç™»å½•ä¿¡æ¯
        const rememberMeCheckbox = document.getElementById("rememberMe");
        if (rememberMeCheckbox.checked) {
          localStorage.setItem("rememberedUsername", username);
          localStorage.setItem("rememberedPassword", password);
          localStorage.setItem("rememberMe", "true");
        } else {
          // å¦‚æœç”¨æˆ·é€‰æ‹©ä¸è®°ä½ï¼Œæ¸…é™¤å·²ä¿å­˜çš„ç™»å½•ä¿¡æ¯
          localStorage.removeItem("rememberedUsername");
          localStorage.removeItem("rememberedPassword");
          localStorage.setItem("rememberMe", "false");
        }

        showMainApp();
      }

      // æ³¨å†Œ
      function register(username, password) {
        const users = JSON.parse(localStorage.getItem("users") || "{}");

        if (users[username]) {
          alert("ç”¨æˆ·åå·²å­˜åœ¨ï¼");
          return;
        }

        users[username] = {
          password: password,
          coins: 100,
          diamonds: 0,
          lotteryCount: 0,
          disciplineLotteryCount: 0,
          totalCompleted: 0,
          checkInDays: 0,
          registerTime: new Date().toLocaleDateString(),
        };

        localStorage.setItem("users", JSON.stringify(users));
        currentUser = username;
        localStorage.setItem("currentUser", username);
        showMainApp();
      }

      // åˆ‡æ¢æ ‡ç­¾é¡µ
      function switchTab(tab) {
        const sections = [
          "todoSection",
          "toolsSection",
          "shopSection",
          "profileSection",
        ];
        const navItems = document.querySelectorAll(".nav-item");

        // éšè—ç©ºç™½é¡µé¢å®¹å™¨
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        if (emptyPageContainer) {
          emptyPageContainer.style.display = "none";
        }

        sections.forEach((section) => {
          document.getElementById(section).classList.remove("active");
        });

        navItems.forEach((item) => item.classList.remove("active"));

        document.getElementById(tab + "Section").classList.add("active");
        navItems[
          ["todo", "tools", "shop", "profile"].indexOf(tab)
        ].classList.add("active");

        if (tab === "todo") {
          loadTodos();
          updateTodoStats();
        }

        // æ§åˆ¶+æŒ‰é’®æ˜¾ç¤º
        toggleAddTodoButton();
      }

      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      function updateProfileInfo() {
        if (!currentUser) return;

        const users = JSON.parse(localStorage.getItem("users") || "{}");
        const user = users[currentUser];

        // æ›´æ–°é¡¶éƒ¨ä¿¡æ¯æ 
        document.getElementById("headerCoins").textContent = user.coins || 0;
        document.getElementById("headerUsername").textContent = currentUser;
        document.getElementById("profileName").textContent = currentUser;
        document.getElementById("profileCoins").textContent = user.coins || 0;
        document.getElementById("profileDiamonds").textContent =
          user.diamonds || 0;
        document.getElementById("profileRegister").textContent =
          user.registerTime || "-";

        // æ›´æ–°é’»çŸ³å’ŒæŠ½å¥–è®¡æ•°
        coins = user.coins || 0;
        diamonds = user.diamonds || 0;
        lotteryCount = user.lotteryCount || 0;
        disciplineLotteryCount = user.disciplineLotteryCount || 0;
        updateDiamondDisplay();

        // æ›´æ–°å¤´åƒæ˜¾ç¤º
        loadAvatar();

        // åŠ è½½ä¸ªæ€§åŒ–è®¾ç½®
        loadPersonalization();
      }

      // åŠ è½½ä¸ªæ€§åŒ–è®¾ç½®
      function loadPersonalization() {
        if (!currentUser) return;

        // åŠ è½½ä¸»é¢˜è‰²
        const savedTheme = localStorage.getItem(`theme_${currentUser}`);
        const themeColor = savedTheme || "#667eea";
        document.documentElement.style.setProperty(
          "--primary-color",
          themeColor
        );
        document.querySelectorAll(".color-option").forEach((opt) => {
          opt.style.border = "2px solid transparent";
          if (opt.dataset.color === themeColor) {
            opt.style.border = "2px solid white";
          }
        });

        // åŠ è½½ç•Œé¢é€æ˜åº¦ï¼ˆç™½è‰²èƒŒæ™¯ï¼‰
        const savedContentOpacity = localStorage.getItem(
          `contentOpacity_${currentUser}`
        );
        const contentOpacity = savedContentOpacity || "0.95";
        document.documentElement.style.setProperty(
          "--content-opacity",
          contentOpacity
        );
        const contentOpacitySlider = document.getElementById(
          "contentOpacitySlider"
        );
        const contentOpacityValue = document.getElementById(
          "contentOpacityValue"
        );
        if (contentOpacitySlider && contentOpacityValue) {
          contentOpacitySlider.value = contentOpacity;
          contentOpacityValue.textContent =
            Math.round(contentOpacity * 100) + "%";
        }

        // åŠ è½½æ–‡å­—æ¡†é€æ˜åº¦ï¼ˆä»»åŠ¡å¡ç‰‡ï¼‰
        const savedTextBoxOpacity = localStorage.getItem(
          `textBoxOpacity_${currentUser}`
        );
        const textBoxOpacity = savedTextBoxOpacity || "0.9";
        document.documentElement.style.setProperty(
          "--text-box-opacity",
          textBoxOpacity
        );
        const textBoxOpacitySlider = document.getElementById(
          "textBoxOpacitySlider"
        );
        const textBoxOpacityValue = document.getElementById(
          "textBoxOpacityValue"
        );
        if (textBoxOpacitySlider && textBoxOpacityValue) {
          textBoxOpacitySlider.value = textBoxOpacity;
          textBoxOpacityValue.textContent =
            Math.round(textBoxOpacity * 100) + "%";
        }

        // åŠ è½½æ¨¡ç³Šç¨‹åº¦
        const savedBlur = localStorage.getItem(`blurAmount_${currentUser}`);
        const blurAmount = savedBlur || "10";
        document.documentElement.style.setProperty(
          "--blur-amount",
          blurAmount + "px"
        );
        const blurSlider = document.getElementById("blurSlider");
        const blurValue = document.getElementById("blurValue");
        if (blurSlider && blurValue) {
          blurSlider.value = blurAmount;
          blurValue.textContent = blurAmount + "px";
        }

        // åŠ è½½èƒŒæ™¯å›¾ç‰‡
        const bgData = localStorage.getItem(`bg_${currentUser}`);
        if (bgData) {
          document.body.style.backgroundImage = `url(${bgData})`;
          document.body.classList.add("has-background");
          document.querySelector(
            ".main-app"
          ).style.background = `rgba(255, 255, 255, var(--content-opacity))`;
        }

        // åŠ è½½ä¸ªæ€§ç­¾å
        const signature = localStorage.getItem(`signature_${currentUser}`);
        if (signature) {
          document.getElementById("profileSignature").value = signature;
        }

        // ç»‘å®šé€æ˜åº¦æ§åˆ¶äº‹ä»¶
        // ç•Œé¢é€æ˜åº¦æ§åˆ¶ï¼ˆç™½è‰²èƒŒæ™¯é€æ˜åº¦ï¼‰
        const contentOpacitySliderEvent = document.getElementById(
          "contentOpacitySlider"
        );
        const contentOpacityValueEvent = document.getElementById(
          "contentOpacityValue"
        );
        if (contentOpacitySliderEvent) {
          contentOpacitySliderEvent.addEventListener("input", function () {
            const contentOpacity = this.value;
            document.documentElement.style.setProperty(
              "--content-opacity",
              contentOpacity
            );
            localStorage.setItem(
              `contentOpacity_${currentUser}`,
              contentOpacity
            );
            contentOpacityValueEvent.textContent =
              Math.round(contentOpacity * 100) + "%";

            // åŒæ­¥æ›´æ–°ä¸»åº”ç”¨èƒŒæ™¯é€æ˜åº¦
            if (document.body.classList.contains("has-background")) {
              document.querySelector(
                ".main-app"
              ).style.background = `rgba(255, 255, 255, ${contentOpacity})`;
            }
          });
        }

        // æ–‡å­—æ¡†é€æ˜åº¦æ§åˆ¶
        const textBoxOpacitySliderEvent = document.getElementById(
          "textBoxOpacitySlider"
        );
        const textBoxOpacityValueEvent = document.getElementById(
          "textBoxOpacityValue"
        );
        if (textBoxOpacitySliderEvent) {
          textBoxOpacitySliderEvent.addEventListener("input", function () {
            const textBoxOpacity = this.value;
            document.documentElement.style.setProperty(
              "--text-box-opacity",
              textBoxOpacity
            );
            localStorage.setItem(
              `textBoxOpacity_${currentUser}`,
              textBoxOpacity
            );
            textBoxOpacityValueEvent.textContent =
              Math.round(textBoxOpacity * 100) + "%";
          });
        }

        // æ¨¡ç³Šç¨‹åº¦æ§åˆ¶
        const blurSliderEvent = document.getElementById("blurSlider");
        const blurValueEvent = document.getElementById("blurValue");
        if (blurSliderEvent) {
          blurSliderEvent.addEventListener("input", function () {
            const blurAmount = this.value;
            document.documentElement.style.setProperty(
              "--blur-amount",
              blurAmount + "px"
            );
            localStorage.setItem(`blurAmount_${currentUser}`, blurAmount);
            blurValueEvent.textContent = blurAmount + "px";
          });
        }

        // ä¸»é¢˜è‰²åˆ‡æ¢
        document.querySelectorAll(".color-option").forEach((option) => {
          option.addEventListener("click", function () {
            const color = this.dataset.color;
            document.documentElement.style.setProperty(
              "--primary-color",
              color
            );
            localStorage.setItem(`theme_${currentUser}`, color);

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll(".color-option").forEach((opt) => {
              opt.style.border = "2px solid transparent";
            });
            this.style.border = "2px solid white";
          });
        });

        // èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ 
        const bgUploadInput = document.getElementById("bgUpload");
        if (bgUploadInput) {
          bgUploadInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
              alert("èƒŒæ™¯å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB");
              return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
              const bgData = e.target.result;
              localStorage.setItem(`bg_${currentUser}`, bgData);
              document.body.style.backgroundImage = `url(${bgData})`;
              document.body.classList.add("has-background");
              document.querySelector(
                ".main-app"
              ).style.background = `rgba(255, 255, 255, var(--content-opacity))`;
              alert("èƒŒæ™¯å›¾ç‰‡è®¾ç½®æˆåŠŸï¼");
            };
            reader.readAsDataURL(file);
          });
        }

        // ä¸ªæ€§ç­¾åä¿å­˜
        const profileSignatureInput =
          document.getElementById("profileSignature");
        if (profileSignatureInput) {
          profileSignatureInput.addEventListener("blur", function () {
            const signature = this.value.trim();
            localStorage.setItem(`signature_${currentUser}`, signature);
          });
        }

        // å¤´åƒä¸Šä¼ åŠŸèƒ½å·²åœ¨å…¶ä»–ä½ç½®å®ç°ï¼Œæ­¤å¤„ä¸å†é‡å¤ç»‘å®šäº‹ä»¶
      }

      // ç™»å‡ºåŠŸèƒ½
      function logout() {
        if (confirm("ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          currentUser = null;
          localStorage.removeItem("currentUser");
          location.reload();
        }
      }

      // è´¦å·æ³¨é”€åŠŸèƒ½
      function deleteAccount() {
        if (
          confirm(
            "è­¦å‘Šï¼ç¡®å®šè¦æ³¨é”€è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åˆ é™¤æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬é‡‘å¸ã€é’»çŸ³ã€ä»»åŠ¡è®°å½•ç­‰ï¼‰ã€‚"
          )
        ) {
          if (currentUser) {
            // åˆ é™¤ç”¨æˆ·æ•°æ®
            const users = JSON.parse(localStorage.getItem("users") || "{}");
            delete users[currentUser];
            localStorage.setItem("users", JSON.stringify(users));

            // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®
            localStorage.clear();

            alert("è´¦å·å·²æˆåŠŸæ³¨é”€ï¼Œæ‰€æœ‰æ•°æ®å·²è¢«åˆ é™¤ã€‚");
            location.reload();
          }
        }
      }

      // æ¸…ç†ç¼“å­˜
      function clearCache() {
        if (
          confirm(
            "ç¡®å®šè¦æ¸…ç†ç¼“å­˜å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®ï¼ŒåŒ…æ‹¬å¤´åƒã€èƒŒæ™¯å›¾ç‰‡å’Œä¸ªæ€§åŒ–è®¾ç½®ï¼Œä½†ä¸ä¼šåˆ é™¤è´¦å·ä¿¡æ¯å’Œé‡‘å¸æ•°æ®ã€‚"
          )
        ) {
          if (currentUser) {
            // ä¿ç•™æ ¸å¿ƒç”¨æˆ·æ•°æ®
            const users = JSON.parse(localStorage.getItem("users") || "{}");
            const userData = users[currentUser];

            // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨
            const keysToKeep = [`users`, `currentUser`];
            const keysToRemove = [];

            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (!keysToKeep.includes(key)) {
                keysToRemove.push(key);
              }
            }

            keysToRemove.forEach((key) => localStorage.removeItem(key));

            // é‡æ–°è®¾ç½®ç”¨æˆ·æ•°æ®
            if (userData) {
              users[currentUser] = userData;
              localStorage.setItem("users", JSON.stringify(users));
            }

            alert("ç¼“å­˜æ¸…ç†å®Œæˆï¼ä¸ªæ€§åŒ–è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼ã€‚");
            location.reload();
          }
        }
      }

      // ç»Ÿä¸€å¤´åƒä¸Šä¼ å¤„ç†
      function setupAvatarUpload() {
        const profileAvatarElement = document.getElementById("profileAvatar");
        if (profileAvatarElement) {
          // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
          const newAvatarElement = profileAvatarElement.cloneNode(true);
          profileAvatarElement.parentNode.replaceChild(
            newAvatarElement,
            profileAvatarElement
          );

          // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
          newAvatarElement.addEventListener("click", function () {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.onchange = function (e) {
              const file = e.target.files[0];
              if (!file) return;

              if (file.size > 2 * 1024 * 1024) {
                alert("å¤´åƒæ–‡ä»¶ä¸èƒ½è¶…è¿‡2MB");
                return;
              }

              const reader = new FileReader();
              reader.onload = function (e) {
                const avatarData = e.target.result;
                localStorage.setItem(`avatar_${currentUser}`, avatarData);
                loadAvatar();
                alert("å¤´åƒä¸Šä¼ æˆåŠŸï¼");
              };
              reader.readAsDataURL(file);
            };
            input.click();
          });
        }
      }

      // åˆå§‹åŒ–å¤´åƒä¸Šä¼ åŠŸèƒ½
      setupAvatarUpload();

      // ç§»é™¤èƒŒæ™¯å›¾ç‰‡
      function removeBackground() {
        if (confirm("ç¡®å®šè¦ç§»é™¤èƒŒæ™¯å›¾ç‰‡å—ï¼Ÿ")) {
          localStorage.removeItem(`bg_${currentUser}`);
          document.body.style.backgroundImage = "";
          document.body.classList.remove("has-background");
          document.querySelector(
            ".main-app"
          ).style.background = `rgba(255, 255, 255, var(--content-opacity))`;
          alert("èƒŒæ™¯å›¾ç‰‡å·²ç§»é™¤ï¼");
        }
      }

      // åŠ è½½å¤´åƒ
      function loadAvatar() {
        const avatarData = localStorage.getItem(`avatar_${currentUser}`);
        if (avatarData) {
          document.getElementById("headerAvatarText").style.display = "none";
          document.getElementById("headerAvatarImg").style.display = "block";
          document.getElementById("headerAvatarImg").src = avatarData;
          document.getElementById(
            "profileAvatar"
          ).innerHTML = `<img src="${avatarData}" alt="ç”¨æˆ·å¤´åƒ" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        } else {
          document.getElementById("headerAvatarText").style.display = "block";
          document.getElementById("headerAvatarText").textContent = currentUser
            .charAt(0)
            .toUpperCase();
          document.getElementById("headerAvatarImg").style.display = "none";
          document.getElementById("profileAvatar").textContent = currentUser
            .charAt(0)
            .toUpperCase();
        }
      }

      // å¤´åƒä¸Šä¼ 
      function uploadAvatar(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 2 * 1024 * 1024) {
          alert("å¤´åƒæ–‡ä»¶ä¸èƒ½è¶…è¿‡2MB");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const avatarData = e.target.result;
          localStorage.setItem(`avatar_${currentUser}`, avatarData);
          loadAvatar();
          alert("å¤´åƒä¸Šä¼ æˆåŠŸï¼");
        };
        reader.readAsDataURL(file);
      }

      // ç‚¹å‡»å¤´åƒè§¦å‘ä¸Šä¼ 
      document
        .getElementById("headerAvatar")
        .addEventListener("click", function () {
          document.getElementById("avatarUpload").click();
        });

      // ä»£åŠåŠŸèƒ½
      function showAddTodo() {
        const modal = document.getElementById("addTodoModal");
        modal.style.display = "flex";

        // é‡ç½®æ ‡é¢˜å’ŒæŒ‰é’®
        document.getElementById("todoModalTitle").textContent = "æ·»åŠ æ–°ä»»åŠ¡";
        document.getElementById("todoSubmitBtn").textContent = "æ·»åŠ ä»»åŠ¡";

        // é‡ç½®è¡¨å•
        document.getElementById("addTodoForm").reset();

        // è‡ªåŠ¨å¡«å†™1å¤©åçš„æ—¶é—´
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(23, 59, 0, 0); // è®¾ç½®ä¸ºå½“å¤©23:59

        const deadlineInput = document.getElementById("todoDeadline");
        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, "0");
        const day = String(tomorrow.getDate()).padStart(2, "0");
        const hours = String(tomorrow.getHours()).padStart(2, "0");
        const minutes = String(tomorrow.getMinutes()).padStart(2, "0");

        deadlineInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;

        // è®¾ç½®ä¼˜å…ˆçº§é»˜è®¤é€‰ä¸­"ä¸­"
        document.getElementById("todoPriority").value = "medium";
      }

      function closeAddTodo() {
        document.getElementById("addTodoModal").style.display = "none";
        document.getElementById("addTodoForm").reset();
      }

      document
        .getElementById("addTodoForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const content = document.getElementById("todoContent").value;
          const deadline = document.getElementById("todoDeadline").value;
          const priority = document.getElementById("todoPriority").value;
          const notes = document.getElementById("todoNotes").value;

          const todo = {
            id: Date.now(),
            content: content,
            deadline: deadline,
            priority: priority,
            notes: notes,
            completed: false,
            createdAt: new Date().toISOString(),
          };

          todos.push(todo);
          saveTodos();
          renderTodos();
          closeAddTodo();
        });

      function saveTodos() {
        if (currentUser) {
          // è¿‡æ»¤æ‰æ— æ•ˆçš„å¾…åŠäº‹é¡¹ï¼šç©ºç™½åç§°æˆ–æˆªæ­¢æ—¥æœŸä¸º"Invalid Date"
          todos = todos.filter((todo) => {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºç™½åç§°
            const hasValidContent = todo.content && todo.content.trim() !== "";

            // æ£€æŸ¥æˆªæ­¢æ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼ˆåˆ é™¤æˆªæ­¢æ—¥æœŸä¸º"Invalid Date"çš„å¾…åŠé¡¹ï¼‰
            const hasValidDeadline =
              !todo.deadline || !isNaN(new Date(todo.deadline).getTime());

            return hasValidContent && hasValidDeadline;
          });

          const userTodos = JSON.parse(localStorage.getItem("todos") || "{}");
          userTodos[currentUser] = todos;
          localStorage.setItem("todos", JSON.stringify(userTodos));
        }
      }

      function loadTodos() {
        if (currentUser) {
          const userTodos = JSON.parse(localStorage.getItem("todos") || "{}");
          todos = userTodos[currentUser] || [];
          renderTodos();
        }
      }

      function renderTodos() {
        const todoList = document.getElementById("todoList");
        todoList.innerHTML = "";

        let filteredTodos = todos;

        if (!showAllTasks) {
          if (showCompletedOnly) {
            filteredTodos = todos.filter((todo) => todo.completed);
          } else if (showPendingOnly) {
            filteredTodos = todos.filter((todo) => !todo.completed);
          }
        }

        filteredTodos.forEach((todo) => {
          const originalIndex = todos.indexOf(todo);
          const todoItem = document.createElement("div");
          todoItem.className = "todo-item";
          todoItem.style.cursor = "pointer";

          let notesHtml = "";
          if (todo.notes && todo.notes.trim() !== "") {
            notesHtml = `<div class="todo-notes" style="font-size: 0.85rem; color: #666; margin-top: 0.3rem; padding-top: 0.3rem; border-top: 1px solid #eee;">å¤‡æ³¨: ${todo.notes}</div>`;
          }

          todoItem.innerHTML = `
                    <input type="checkbox" class="todo-checkbox" ${
                      todo.completed ? "checked" : ""
                    } 
                           onchange="toggleTodo(${
                             todo.id
                           }); event.stopPropagation();">
                    <div class="todo-content" onclick="editTodo(${originalIndex})">
                        <div class="todo-title">${todo.content}</div>
                        <div class="todo-time">æˆªæ­¢: ${new Date(
                          todo.deadline
                        ).toLocaleString()}</div>
                        ${notesHtml}
                    </div>
                    <span class="todo-priority priority-${
                      todo.priority
                    }">${getPriorityText(todo.priority)}</span>
                `;
          todoList.appendChild(todoItem);
        });

        updateTodoStats();
        updateActiveFilters();
      }

      function getPriorityText(priority) {
        const map = { low: "ä½", medium: "ä¸­", high: "é«˜" };
        return map[priority] || priority;
      }

      function toggleTodo(id) {
        const todo = todos.find((t) => t.id === id);
        if (todo) {
          const wasCompleted = todo.completed;
          todo.completed = !todo.completed;

          if (todo.completed && !wasCompleted) {
            const users = JSON.parse(localStorage.getItem("users") || "{}");
            users[currentUser].totalCompleted =
              (users[currentUser].totalCompleted || 0) + 1;

            // æ›´æ–°æ¯æ—¥æŒ‘æˆ˜è¿›åº¦
            const today = new Date().toDateString();
            if (users[currentUser].lastDailyChallenge !== today) {
              users[currentUser].dailyCompletedTasks = 0;
              users[currentUser].dailyRewards = [];
              users[currentUser].lastDailyChallenge = today;
            }

            users[currentUser].dailyCompletedTasks =
              (users[currentUser].dailyCompletedTasks || 0) + 1;

            // æ£€æŸ¥å¹¶æ·»åŠ æ¯æ—¥æŒ‘æˆ˜å¥–åŠ±
            const completedTasks = users[currentUser].dailyCompletedTasks;
            if (completedTasks <= 4) {
              users[currentUser].dailyRewards =
                users[currentUser].dailyRewards || [];
              users[currentUser].dailyRewards.push({
                description: `å®Œæˆç¬¬${completedTasks}ä¸ªä»£åŠä»»åŠ¡å¥–åŠ±`,
                amount: 10,
              });

              if (completedTasks === 4) {
                users[currentUser].dailyRewards.push({
                  description: `å®Œæˆ4ä¸ªä»£åŠä»»åŠ¡é¢å¤–å¥–åŠ±`,
                  amount: 20,
                });
              }
            }

            localStorage.setItem("users", JSON.stringify(users));

            // æ›´æ–°å…¨å±€å˜é‡å¹¶ä¿å­˜
            coins = users[currentUser].coins;
            saveUserData();
            updateProfileInfo();
            updateCoinDisplay();
          }

          saveTodos();
          renderTodos();
        }
      }

      function updateTodoStats() {
        const total = todos.length;
        const completed = todos.filter((t) => t.completed).length;
        const pending = total - completed;

        document.getElementById("totalTasks").textContent = total;
        document.getElementById("completedTasks").textContent = completed;
        document.getElementById("pendingTasks").textContent = pending;
      }

      function toggleShowAllTasks() {
        showAllTasks = true;
        showCompletedOnly = false;
        showPendingOnly = false;
        renderTodos();
      }

      function toggleShowCompletedOnly() {
        if (showCompletedOnly) {
          // å¦‚æœå·²ç»æ˜¯å·²å®ŒæˆçŠ¶æ€ï¼Œåˆ‡æ¢å›å…¨éƒ¨
          showAllTasks = true;
          showCompletedOnly = false;
        } else {
          showAllTasks = false;
          showCompletedOnly = true;
          showPendingOnly = false;
        }
        renderTodos();
      }

      function toggleShowPendingOnly() {
        if (showPendingOnly) {
          // å¦‚æœå·²ç»æ˜¯æœªå®ŒæˆçŠ¶æ€ï¼Œåˆ‡æ¢å›å…¨éƒ¨
          showAllTasks = true;
          showPendingOnly = false;
        } else {
          showAllTasks = false;
          showCompletedOnly = false;
          showPendingOnly = true;
        }
        renderTodos();
      }

      function updateActiveFilters() {
        const totalCard = document.getElementById("totalTasksCard");
        const completedCard = document.getElementById("completedTasksCard");
        const pendingCard = document.getElementById("pendingTasksCard");

        totalCard.style.backgroundColor = showAllTasks ? "#e3f2fd" : "";
        totalCard.style.transform = showAllTasks ? "scale(1.05)" : "";

        completedCard.style.backgroundColor = showCompletedOnly
          ? "#e8f5e8"
          : "";
        completedCard.style.transform = showCompletedOnly ? "scale(1.05)" : "";

        pendingCard.style.backgroundColor = showPendingOnly ? "#fff3e0" : "";
        pendingCard.style.transform = showPendingOnly ? "scale(1.05)" : "";
      }

      function editTodo(index) {
        const todo = todos[index];
        if (!todo) return;

        // è®¾ç½®å½“å‰ç¼–è¾‘çš„å¾…åŠäº‹é¡¹
        window.currentEditingTodo = todo;

        // ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’ŒæŒ‰é’®
        document.getElementById("todoModalTitle").textContent = "ç¼–è¾‘ä»»åŠ¡";
        document.getElementById("todoSubmitBtn").textContent = "ä¿å­˜ä¿®æ”¹";

        // éšè—"æ·»åŠ åˆ°ç•ªèŒ„é’Ÿ"é€‰é¡¹ï¼ˆæ­¤åŠŸèƒ½å·²è¢«ç§»é™¤ï¼‰
        const addToTomatoClockElement =
          document.getElementById("addToTomatoClock");
        if (addToTomatoClockElement && addToTomatoClockElement.parentElement) {
          addToTomatoClockElement.parentElement.style.display = "none";
        }

        // å¡«å……ç¼–è¾‘è¡¨å•
        document.getElementById("todoContent").value = todo.content;
        document.getElementById("todoDeadline").value = todo.deadline;
        document.getElementById("todoPriority").value = todo.priority;
        document.getElementById("todoNotes").value = todo.notes || "";

        // ä¿®æ”¹æäº¤å¤„ç†
        const form = document.getElementById("addTodoForm");
        const originalHandler = form.onsubmit;
        // ä¿å­˜åŸå§‹å¤„ç†ç¨‹åºåˆ°windowå¯¹è±¡ï¼Œä»¥ä¾¿å…¨å±€è®¿é—®
        window.originalAddTodoHandler = originalHandler;

        form.onsubmit = function (e) {
          e.preventDefault();

          todo.content = document.getElementById("todoContent").value;
          todo.deadline = document.getElementById("todoDeadline").value;
          todo.priority = document.getElementById("todoPriority").value;
          todo.notes = document.getElementById("todoNotes").value;

          saveTodos();
          renderTodos();
          closeAddTodo();

          // æ¢å¤åŸå§‹å¤„ç†ç¨‹åºå’ŒUIçŠ¶æ€
          form.onsubmit = originalHandler;
          document.getElementById("todoModalTitle").textContent = "æ·»åŠ æ–°ä»»åŠ¡";
          document.getElementById("todoSubmitBtn").textContent = "æ·»åŠ ä»»åŠ¡";
          // æ¸…é™¤å½“å‰ç¼–è¾‘çŠ¶æ€
          window.currentEditingTodo = null;

          // æ¢å¤"æ·»åŠ åˆ°ç•ªèŒ„é’Ÿ"é€‰é¡¹çš„æ˜¾ç¤ºï¼ˆæ­¤åŠŸèƒ½å·²è¢«ç§»é™¤ï¼‰
          const addToTomatoClockElement =
            document.getElementById("addToTomatoClock");
          if (
            addToTomatoClockElement &&
            addToTomatoClockElement.parentElement
          ) {
            addToTomatoClockElement.parentElement.style.display = "";
          }
        };

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        document.getElementById("addTodoModal").style.display = "flex";

        // æ·»åŠ å–æ¶ˆæŒ‰é’®äº‹ä»¶
        const cancelEdit = function () {
          form.onsubmit = originalHandler;
          closeAddTodo();
          document.getElementById("todoModalTitle").textContent = "æ·»åŠ æ–°ä»»åŠ¡";
          document.getElementById("todoSubmitBtn").textContent = "æ·»åŠ ä»»åŠ¡";

          // æ¢å¤"æ·»åŠ åˆ°ç•ªèŒ„é’Ÿ"é€‰é¡¹çš„æ˜¾ç¤ºï¼ˆæ­¤åŠŸèƒ½å·²è¢«ç§»é™¤ï¼‰
          const addToTomatoClockElement =
            document.getElementById("addToTomatoClock");
          if (
            addToTomatoClockElement &&
            addToTomatoClockElement.parentElement
          ) {
            addToTomatoClockElement.parentElement.style.display = "";
          }
        };

        // ç›‘å¬æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        document
          .getElementById("addTodoModal")
          .addEventListener("click", function closeHandler(e) {
            if (e.target === this) {
              cancelEdit();
              this.removeEventListener("click", closeHandler);
            }
          });
      }

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      document
        .getElementById("addTodoModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            // æ£€æŸ¥æ˜¯å¦å¤„äºç¼–è¾‘æ¨¡å¼
            const isEditMode =
              document.getElementById("todoModalTitle").textContent ===
              "ç¼–è¾‘ä»»åŠ¡";
            if (window.currentEditingTodo && isEditMode) {
              // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œç¡®ä¿æ¢å¤åŸå§‹è¡¨å•å¤„ç†ç¨‹åº
              const form = document.getElementById("addTodoForm");
              if (window.originalAddTodoHandler) {
                form.onsubmit = window.originalAddTodoHandler;
              }
              document.getElementById("todoModalTitle").textContent =
                "æ·»åŠ æ–°ä»»åŠ¡";
              document.getElementById("todoSubmitBtn").textContent = "æ·»åŠ ä»»åŠ¡";

              // æ¢å¤"æ·»åŠ åˆ°ç•ªèŒ„é’Ÿ"é€‰é¡¹çš„æ˜¾ç¤º
              const addToTomatoClockContainer =
                document.getElementById("addToTomatoClock").parentElement;
              if (addToTomatoClockContainer) {
                addToTomatoClockContainer.style.display = "";
              }

              window.currentEditingTodo = null;
            }
            closeAddTodo();
          }
        });

      // å•†åŸç•Œé¢åˆ‡æ¢å‡½æ•°
      function showLottery() {
        document.querySelector(".shop-container").style.display = "none";
        document.getElementById("lotterySection").style.display = "block";
      }

      function hideLottery() {
        document.getElementById("lotterySection").style.display = "none";
        document.querySelector(".shop-container").style.display = "flex";
      }

      function showExchange() {
        document.querySelector(".shop-container").style.display = "none";
        document.getElementById("exchangeSection").style.display = "block";

        // æ›´æ–°å…‘æ¢ç•Œé¢æ˜¾ç¤ºçš„æ‰€æœ‰è´§å¸æ•°é‡
        const coinCountEl = document.getElementById("exchangeCoinCount");
        if (coinCountEl) coinCountEl.textContent = coins;

        const diamondCountEl = document.getElementById("exchangeDiamondCount");
        if (diamondCountEl) diamondCountEl.textContent = diamonds;

        const disciplineCoinCountEl = document.getElementById(
          "exchangeDisciplineCoinCount"
        );
        if (disciplineCoinCountEl)
          disciplineCoinCountEl.textContent = disciplineCoins;
      }

      function hideExchange() {
        document.getElementById("exchangeSection").style.display = "none";
        document.querySelector(".shop-container").style.display = "flex";
      }

      // åŠ å…¥æˆ‘ä»¬åŠŸèƒ½
      function joinUs() {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.id = "joinUsModal";

        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>åŠ å…¥æˆ‘ä»¬</h3>
              <button class="close-btn" onclick="document.getElementById('joinUsModal').remove()">&times;</button>
            </div>
            <div style="padding: 1rem 0;">
              <p style="margin-bottom: 1rem;">æ„Ÿè°¢æ‚¨å¯¹è‡ªå¾‹åŠ©æ‰‹çš„å…³æ³¨å’Œæ”¯æŒï¼</p>
              <p style="margin-bottom: 1rem;">æˆ‘ä»¬æ˜¯ä¸€ä¸ªè‡´åŠ›äºå¸®åŠ©ç”¨æˆ·æé«˜è‡ªå¾‹èƒ½åŠ›çš„å›¢é˜Ÿã€‚</p>
              <p style="margin-bottom: 1rem;">å¦‚æœæ‚¨æœ‰å…´è¶£åŠ å…¥æˆ‘ä»¬æˆ–äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š</p>
              <div style="margin: 1rem 0;">
                <p>ğŸ“§ é‚®ç®±ï¼š2181927847@qq.com</p>
                <p>ğŸ“± ç”µè¯ï¼š13012708819</p>
                <p>ğŸ’¬ å¾®ä¿¡ï¼šnick20090120</p>
              </div>
              <p style="color: var(--primary-color); font-size: 0.9rem; margin-top: 1.5rem;">æˆ‘ä»¬æœŸå¾…æ‚¨çš„åŠ å…¥ï¼</p>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // åé¦ˆé”™è¯¯åŠŸèƒ½
      function feedbackError() {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.id = "feedbackModal";

        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>åé¦ˆé”™è¯¯</h3>
              <button class="close-btn" onclick="document.getElementById('feedbackModal').remove()">&times;</button>
            </div>
            <form id="feedbackForm">
              <div class="form-group">
                <label>é”™è¯¯ç±»å‹</label>
                <select id="errorType" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none;">
                  <option value="åŠŸèƒ½å¼‚å¸¸">åŠŸèƒ½å¼‚å¸¸</option>
                  <option value="ç•Œé¢æ˜¾ç¤º">ç•Œé¢æ˜¾ç¤ºé—®é¢˜</option>
                  <option value="æ€§èƒ½é—®é¢˜">æ€§èƒ½é—®é¢˜</option>
                  <option value="åŠŸèƒ½å»ºè®®">åŠŸèƒ½å»ºè®®</option>
                  <option value="å…¶ä»–">å…¶ä»–é—®é¢˜</option>
                </select>
              </div>
              <div class="form-group">
                <label>é”™è¯¯æè¿°</label>
                <textarea id="errorDescription" rows="4" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜..." style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical; outline: none; font-family: inherit;"></textarea>
              </div>
              <div class="form-group">
                <label>è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="contactInfo" placeholder="é‚®ç®±æˆ–å¾®ä¿¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬è”ç³»æ‚¨" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none;">
              </div>
              <button type="submit" class="btn">æäº¤åé¦ˆ</button>
            </form>
            <div id="feedbackResult" style="margin-top: 1rem; min-height: 1.5rem;"></div>
          </div>
        `;

        document.body.appendChild(modal);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            modal.remove();
          }
        });

        // è¡¨å•æäº¤å¤„ç†
        document
          .getElementById("feedbackForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const errorType = document.getElementById("errorType").value;
            const errorDescription =
              document.getElementById("errorDescription").value;
            const contactInfo = document.getElementById("contactInfo").value;

            if (!errorDescription.trim()) {
              document.getElementById("feedbackResult").innerHTML =
                '<p style="color: #ff6b6b;">è¯·æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜</p>';
              return;
            }

            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„åé¦ˆæäº¤é€»è¾‘ï¼Œç›®å‰åªæ˜¯æ¨¡æ‹Ÿ
            // ä¿å­˜åé¦ˆåˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
            const feedbackData = {
              type: errorType,
              description: errorDescription,
              contact: contactInfo,
              timestamp: new Date().toISOString(),
            };

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥å‘é€åˆ°æœåŠ¡å™¨ï¼‰
            const feedbacks = JSON.parse(
              localStorage.getItem("feedbacks") || "[]"
            );
            feedbacks.push(feedbackData);
            localStorage.setItem("feedbacks", JSON.stringify(feedbacks));

            document.getElementById("feedbackResult").innerHTML =
              '<p style="color: #4ecdc4;">æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚</p>';

            // 3ç§’åå…³é—­æ¨¡æ€æ¡†
            setTimeout(function () {
              modal.remove();
            }, 1500);
          });
      }

      // è§£é”ç•Œé¢å‡½æ•°
      window.showUnlockScreen = function () {
        // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„äºé”æœºçŠ¶æ€
        const endTime = localStorage.getItem("lockScreenEndTime");
        const settings = localStorage.getItem("lockScreenSettings");

        if (!endTime || !settings) return;

        const now = new Date().getTime();
        if (now >= parseInt(endTime)) {
          localStorage.removeItem("lockScreenEndTime");
          return;
        }

        // åˆ›å»ºå…¨å±é”å®šç•Œé¢
        const lockScreenOverlay = document.createElement("div");
        lockScreenOverlay.id = "fullscreenLockOverlay";
        lockScreenOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            user-select: none;
            backdrop-filter: blur(5px);
          `;

        // è§£æè®¾ç½®
        const lockSettings = JSON.parse(settings);
        const timeLeft = parseInt(endTime) - now;
        const totalDuration = lockSettings.duration * 60 * 1000;
        const progress = ((totalDuration - timeLeft) / totalDuration) * 100;

        // æ ¼å¼åŒ–å€’è®¡æ—¶å‡½æ•°
        function formatCountdown(ms) {
          const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((ms % (1000 * 60)) / 1000);
          return `${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
        }

        // è§£é”ç•Œé¢HTML
        lockScreenOverlay.innerHTML = `
            <div style="text-align: center; max-width: 400px; padding: 2rem;">
              <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--primary-color);">ç”µè„‘å·²é”å®š</h2>
              <div style="font-size: 5rem; font-weight: bold; margin-bottom: 2rem;">${formatCountdown(
                timeLeft
              )}</div>
              <div style="width: 100%; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; margin-bottom: 2rem;">
                <div id="lockProgressBar" style="
                  width: ${progress}%;
                  height: 100%;
                  background: var(--primary-color);
                  border-radius: 5px;
                  transition: width 1s linear;
                "></div>
              </div>
              <div style="margin-bottom: 1.5rem;">
                <input type="password" id="unlockPassword" placeholder="è¾“å…¥å¯†ç è§£é”" style="
                  width: 100%;
                  padding: 1rem;
                  font-size: 1.2rem;
                  background: rgba(255,255,255,0.1);
                  border: 2px solid rgba(255,255,255,0.3);
                  border-radius: 8px;
                  color: white;
                  outline: none;
                  text-align: center;
                ">
                <div id="unlockError" style="color: #f44336; margin-top: 0.5rem; display: none;">å¯†ç é”™è¯¯</div>
              </div>
              <button id="unlockButton" class="btn" style="
                background: var(--primary-color);
                color: white;
                padding: 1rem 2rem;
                font-size: 1.1rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                width: 100%;
              ">è§£é”ç”µè„‘</button>
              <div style="margin-top: 2rem; font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                <p>ç™½åå•åº”ç”¨å¯æ­£å¸¸ä½¿ç”¨</p>
                <p style="margin-top: 0.5rem; font-size: 0.8rem;">æç¤ºï¼šå®Œæ•´çš„ç³»ç»Ÿçº§é”æœºåŠŸèƒ½éœ€è¦é…åˆåå°è„šæœ¬</p>
              </div>
            </div>
          `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(lockScreenOverlay);

        // èšç„¦å¯†ç è¾“å…¥æ¡†
        const unlockPassword = document.getElementById("unlockPassword");
        if (unlockPassword) unlockPassword.focus();

        // å€’è®¡æ—¶æ›´æ–°
        const countdownInterval = setInterval(() => {
          const currentTime = new Date().getTime();
          const remainingTime = parseInt(endTime) - currentTime;

          if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            if (document.getElementById("fullscreenLockOverlay")) {
              document.body.removeChild(
                document.getElementById("fullscreenLockOverlay")
              );
            }
            localStorage.removeItem("lockScreenEndTime");
            showNotification("å®Œæˆ", "ç”µè„‘å·²è‡ªåŠ¨è§£é”");
            return;
          }

          // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
          const countdownElement = lockScreenOverlay.querySelector(
            'div[style*="font-size: 5rem"]'
          );
          if (countdownElement) {
            countdownElement.textContent = formatCountdown(remainingTime);
          }

          // æ›´æ–°è¿›åº¦æ¡
          const newProgress =
            ((totalDuration - remainingTime) / totalDuration) * 100;
          const progressBar = document.getElementById("lockProgressBar");
          if (progressBar) {
            progressBar.style.width = `${newProgress}%`;
          }
        }, 1000);

        // å°è¯•è§£é”å‡½æ•°
        function attemptUnlock() {
          const enteredPassword =
            document.getElementById("unlockPassword").value;
          const unlockError = document.getElementById("unlockError");

          if (enteredPassword === lockSettings.password) {
            // è§£é”æˆåŠŸ
            clearInterval(countdownInterval);
            if (document.getElementById("fullscreenLockOverlay")) {
              document.body.removeChild(
                document.getElementById("fullscreenLockOverlay")
              );
            }
            localStorage.removeItem("lockScreenEndTime");
            showNotification("æˆåŠŸ", "ç”µè„‘å·²è§£é”");
          } else {
            // è§£é”å¤±è´¥
            if (unlockError) {
              unlockError.style.display = "block";
            }
            unlockPassword.value = "";
            unlockPassword.focus();
          }
        }

        // è§£é”æŒ‰é’®äº‹ä»¶
        document
          .getElementById("unlockButton")
          .addEventListener("click", attemptUnlock);

        // å¯†ç è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        if (unlockPassword) {
          unlockPassword.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              attemptUnlock();
            }
          });
        }
      };

      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºè§£é”ç•Œé¢
      function checkLockScreenStatus() {
        const endTime = localStorage.getItem("lockScreenEndTime");

        if (endTime) {
          const now = new Date().getTime();
          if (now < parseInt(endTime)) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è§£é”ç•Œé¢
            if (
              !document.getElementById("fullscreenLockOverlay") &&
              window.showUnlockScreen
            ) {
              window.showUnlockScreen();
            }
          } else {
            // æ—¶é—´å·²åˆ°ï¼Œæ¸…é™¤é”æœºçŠ¶æ€
            localStorage.removeItem("lockScreenEndTime");
          }
        }
      }

      // å®šæœŸæ£€æŸ¥é”æœºçŠ¶æ€
      setInterval(checkLockScreenStatus, 5000);

      // åˆå§‹æ£€æŸ¥
      checkLockScreenStatus();

      // å±è”½ç½‘ç«™åŠŸèƒ½å®ç°
      function showWebsiteBlocker() {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å®¹å™¨");
          showNotification("é”™è¯¯", "æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å…ƒç´ ");
          return;
        }

        // æ¸…ç©ºå®¹å™¨ä½†ä¿ç•™æ ‡é¢˜å…ƒç´ 
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild !== emptyPageTitle) {
            emptyPageContainer.removeChild(emptyPageContainer.firstChild);
          } else {
            break;
          }
        }

        // åˆ›å»ºå±è”½ç½‘ç«™ç•Œé¢
        const websiteBlockerContainer = document.createElement("div");
        websiteBlockerContainer.className = "website-blocker-container";
        websiteBlockerContainer.style.cssText = `
            background: rgba(255, 255, 255, var(--text-box-opacity));
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem auto;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          `;

        // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å±è”½ä¸­
        const isBlocking =
          localStorage.getItem("websiteBlockingEnabled") === "true";
        const blockMode = localStorage.getItem("blockMode") || "blacklist"; // blacklist æˆ– whitelist
        const blockedSites = localStorage.getItem("blockedSites") || "";
        const whitelistedSites = localStorage.getItem("whitelistedSites") || "";

        // å±è”½ç½‘ç«™HTMLç»“æ„
        websiteBlockerContainer.innerHTML = `
            <div style="margin-bottom: 2rem;">
              <h4 style="color: var(--primary-color); margin: 0 0 1.5rem 0;">ç½‘ç«™å±è”½è®¾ç½®</h4>
              
              <!-- æ¨¡å¼é€‰æ‹© -->
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">å±è”½æ¨¡å¼</label>
                <div style="display: flex; gap: 1rem;">
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="blockMode" value="blacklist" ${
                      blockMode === "blacklist" ? "checked" : ""
                    } style="margin-right: 0.5rem;">
                    <span>é»‘åå•æ¨¡å¼</span>
                  </label>
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="blockMode" value="whitelist" ${
                      blockMode === "whitelist" ? "checked" : ""
                    } style="margin-right: 0.5rem;">
                    <span>ç™½åå•æ¨¡å¼</span>
                  </label>
                </div>
              </div>
              
              <!-- é»‘åå•ç½‘ç«™è¾“å…¥ -->
              <div id="blacklistContainer" ${
                blockMode === "blacklist" ? "" : 'style="display: none;"'
              }>
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">é»‘åå•ç½‘ç«™ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ www.example.comï¼‰</label>
                <textarea id="blockedSites" placeholder="www.youtube.com
www.facebook.com
www.twitter.com" rows="6" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  resize: vertical;
                  outline: none;
                ">${blockedSites}</textarea>
              </div>
              
              <!-- ç™½åå•ç½‘ç«™è¾“å…¥ -->
              <div id="whitelistContainer" ${
                blockMode === "whitelist" ? "" : 'style="display: none;"'
              }>
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">ç™½åå•ç½‘ç«™ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ www.google.comï¼‰</label>
                <textarea id="whitelistedSites" placeholder="www.google.com
www.baidu.com
www.github.com" rows="6" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  resize: vertical;
                  outline: none;
                ">${whitelistedSites}</textarea>
              </div>
            </div>
            
            <!-- æ§åˆ¶æŒ‰é’® -->
            <div style="display: flex; gap: 1rem; justify-content: center;">
              <button id="saveBlockSettings" class="btn" style="background: var(--primary-color); color: white;">ä¿å­˜è®¾ç½®</button>
              <button id="${
                isBlocking ? "stop" : "start"
              }Blocking" class="btn" style="background: ${
          isBlocking ? "#f44336" : "#4caf50"
        }; color: white;">${isBlocking ? "åœæ­¢å±è”½" : "å¼€å§‹å±è”½"}</button>
            </div>
            
            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div id="blockingStatus" style="margin-top: 1.5rem; text-align: center; ${
              isBlocking ? "color: #4caf50;" : "color: #888;"
            }">
              ${isBlocking ? "ç½‘ç«™å±è”½å·²å¯ç”¨" : "ç½‘ç«™å±è”½å·²ç¦ç”¨"}
            </div>
          `;

        // æ·»åŠ åˆ°å®¹å™¨
        emptyPageContainer.appendChild(websiteBlockerContainer);

        // æ¨¡å¼åˆ‡æ¢äº‹ä»¶
        const blockModeRadios = document.querySelectorAll(
          'input[name="blockMode"]'
        );
        blockModeRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            const mode = this.value;
            document.getElementById("blacklistContainer").style.display =
              mode === "blacklist" ? "block" : "none";
            document.getElementById("whitelistContainer").style.display =
              mode === "whitelist" ? "block" : "none";
          });
        });

        // ä¿å­˜è®¾ç½®
        document
          .getElementById("saveBlockSettings")
          .addEventListener("click", function () {
            const blockMode = document.querySelector(
              'input[name="blockMode"]:checked'
            ).value;
            const blockedSites = document.getElementById("blockedSites").value;
            const whitelistedSites =
              document.getElementById("whitelistedSites").value;

            localStorage.setItem("blockMode", blockMode);
            localStorage.setItem("blockedSites", blockedSites);
            localStorage.setItem("whitelistedSites", whitelistedSites);

            // ç¡®ä¿showNotificationå‡½æ•°è¢«æ­£ç¡®è°ƒç”¨
            if (typeof showNotification === "function") {
              showNotification("æˆåŠŸ", "å±è”½è®¾ç½®å·²ä¿å­˜");
            } else {
              console.log("ä¿å­˜è®¾ç½®æˆåŠŸ");
            }
          });

        // å¼€å§‹/åœæ­¢å±è”½
        const toggleBlocking = function () {
          // æ¯æ¬¡ç‚¹å‡»æ—¶é‡æ–°ä»localStorageè·å–å½“å‰çŠ¶æ€
          const currentStatus =
            localStorage.getItem("websiteBlockingEnabled") === "true";
          const newStatus = !currentStatus;

          localStorage.setItem("websiteBlockingEnabled", newStatus);

          // æ›´æ–°UI
          document.getElementById("blockingStatus").textContent = newStatus
            ? "ç½‘ç«™å±è”½å·²å¯ç”¨"
            : "ç½‘ç«™å±è”½å·²ç¦ç”¨";
          document.getElementById("blockingStatus").style.color = newStatus
            ? "#4caf50"
            : "#888";

          // æ›´æ–°å½“å‰æŒ‰é’®
          const button = this;
          button.textContent = newStatus ? "åœæ­¢å±è”½" : "å¼€å§‹å±è”½";
          button.style.background = newStatus ? "#f44336" : "#4caf50";
          button.id = newStatus ? "stopBlocking" : "startBlocking";

          // å¦‚æœæ˜¯å¼€å§‹å±è”½ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è§„åˆ™
          if (newStatus) {
            const blockMode = document.querySelector(
              'input[name="blockMode"]:checked'
            ).value;
            const sitesText =
              blockMode === "blacklist"
                ? document.getElementById("blockedSites").value
                : document.getElementById("whitelistedSites").value;

            if (!sitesText.trim()) {
              if (typeof showNotification === "function") {
                showNotification(
                  "æç¤º",
                  blockMode === "blacklist"
                    ? "é»‘åå•ä¸ºç©ºï¼Œæ‰€æœ‰ç½‘ç«™å‡å¯è®¿é—®"
                    : "ç™½åå•ä¸ºç©ºï¼Œæ‰€æœ‰ç½‘ç«™å‡è¢«å±è”½"
                );
              }
            }
          }

          // æ˜¾ç¤ºæˆåŠŸæç¤º
          if (typeof showNotification === "function") {
            showNotification(
              "æˆåŠŸ",
              newStatus ? "å·²å¼€å§‹å±è”½ç½‘ç«™" : "å·²åœæ­¢å±è”½ç½‘ç«™"
            );
          } else {
            console.log(newStatus ? "å·²å¼€å§‹å±è”½ç½‘ç«™" : "å·²åœæ­¢å±è”½ç½‘ç«™");
          }
        };

        document
          .getElementById(isBlocking ? "stopBlocking" : "startBlocking")
          .addEventListener("click", toggleBlocking);

        // æ˜¾ç¤ºç•Œé¢
        emptyPageContainer.style.display = "block";
        emptyPageTitle.textContent = "å±è”½ç½‘ç«™";
      }

      // è‡ªå¾‹æ—¥å†åŠŸèƒ½å®ç°
      const CALENDAR_DATA_KEY = "discipline_calendar_data";
      let calendarData = {};

      function clearContent() {
        // åªæ¸…ç©ºå½“å‰æ´»åŠ¨çš„sectionï¼Œè€Œä¸æ˜¯æ•´ä¸ªcontent-area
        const activeSections = document.querySelectorAll(
          ".todo-section.active, .tools-section.active, .shop-section.active, .profile-section.active"
        );
        if (activeSections.length > 0) {
          activeSections.forEach((section) => {
            section.innerHTML = "";
          });
        } else {
          // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„sectionï¼Œæ‰æ¸…ç©ºcontent-area
          const content =
            document.querySelector(".content-area") ||
            document.getElementById("content");
          if (content) {
            // ä¿ç•™æ‰€æœ‰ä¸»è¦sectionç»“æ„ï¼Œåªæ¸…ç©ºå®ƒä»¬çš„å†…å®¹
            const sections = [
              document.getElementById("todoSection"),
              document.getElementById("toolsSection"),
              document.getElementById("shopSection"),
              document.getElementById("profileSection"),
            ];

            // å¦‚æœæ‰¾åˆ°äº†è¿™äº›sectionï¼Œåªæ¸…ç©ºå®ƒä»¬çš„å†…å®¹
            let foundSections = false;
            sections.forEach((section) => {
              if (section) {
                foundSections = true;
                section.innerHTML = "";
              }
            });

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸»è¦sectionï¼Œæ‰æ¸…ç©ºæ•´ä¸ªcontent-area
            if (!foundSections) {
              content.innerHTML = "";
            }
          }
        }
      }

      // çŠ¶æ€æ›´æ–°å‡½æ•°
      function updateStatus(message) {
        // å°è¯•è·å–statusBarå…ƒç´ 
        const statusBar =
          document.querySelector(".status-bar") ||
          document.getElementById("statusBar");
        if (statusBar) {
          statusBar.textContent = message;
        } else {
          // å¦‚æœæ²¡æœ‰statusBarå…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥æˆ–åœ¨æ§åˆ¶å°è¾“å‡º
          console.log("çŠ¶æ€æ›´æ–°:", message);
        }
      }

      function showLearningCalendar() {
        // è°ƒç”¨showEmptyPageæ¥å‡†å¤‡å®¹å™¨ï¼Œè®¾ç½®æ ‡é¢˜ä¸º"è‡ªå¾‹æ—¥å†"
        showEmptyPage("è‡ªå¾‹æ—¥å†");

        // è·å–emptyPageContainerå’ŒemptyPageTitle
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å®¹å™¨");
          return;
        }

        // æ¸…ç©ºå®¹å™¨ä½†ä¿ç•™æ ‡é¢˜å…ƒç´ 
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild === emptyPageTitle) {
            break;
          }
          emptyPageContainer.removeChild(emptyPageContainer.firstChild);
        }

        loadCalendarData();

        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        // æ·»åŠ çŠ¶æ€å˜é‡æ¥è·Ÿè¸ªå½“å‰æ˜¾ç¤ºçš„æœˆä»½å’Œå¹´ä»½
        if (!window.calendarState) {
          window.calendarState = { month: currentMonth, year: currentYear };
        } else {
          currentMonth = window.calendarState.month;
          currentYear = window.calendarState.year;
        }

        const container = document.createElement("div");
        container.className = "calendar-container";
        container.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          border-radius: 15px;
          padding: 2rem;
          margin: 1rem auto;
          max-width: 800px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        `;

        // Header with month/year and navigation
        const header = document.createElement("div");
        header.className = "calendar-header";

        const title = document.createElement("h3");
        title.textContent = `${new Date(
          currentYear,
          currentMonth,
          1
        ).toLocaleString("zh-CN", { month: "long" })} ${currentYear}`;
        header.appendChild(title);

        const nav = document.createElement("div");
        nav.className = "calendar-nav";

        const prevButton = document.createElement("button");
        prevButton.textContent = "â†";
        prevButton.addEventListener("click", () => {
          if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
          } else {
            currentMonth--;
          }
          window.calendarState = { month: currentMonth, year: currentYear };
          showLearningCalendar();
        });

        const nextButton = document.createElement("button");
        nextButton.textContent = "â†’";
        nextButton.addEventListener("click", () => {
          if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
          } else {
            currentMonth++;
          }
          window.calendarState = { month: currentMonth, year: currentYear };
          showLearningCalendar();
        });

        nav.appendChild(prevButton);
        nav.appendChild(nextButton);
        header.appendChild(nav);
        container.appendChild(header);

        // Day names header
        const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        const dayNamesRow = document.createElement("div");
        dayNamesRow.className = "calendar-grid";

        dayNames.forEach((day) => {
          const dayElement = document.createElement("div");
          dayElement.textContent = day;
          dayElement.style.fontWeight = "bold";
          dayNamesRow.appendChild(dayElement);
        });

        container.appendChild(dayNamesRow);

        // Calendar grid
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(
          currentYear,
          currentMonth + 1,
          0
        ).getDate();

        const grid = document.createElement("div");
        grid.className = "calendar-grid";

        // Empty cells for days before the first of the month
        for (let i = 0; i < firstDay; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "calendar-day empty";
          grid.appendChild(emptyCell);
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          const dayData = calendarData[dateStr];

          const dayElement = document.createElement("div");
          dayElement.className = "calendar-day";

          const dayNumber = document.createElement("div");
          dayNumber.textContent = day;
          dayElement.appendChild(dayNumber);

          if (
            day === today.getDate() &&
            currentMonth === today.getMonth() &&
            currentYear === today.getFullYear()
          ) {
            dayElement.classList.add("today");
          }

          if (dayData) {
            dayElement.classList.add("has-data");
            dayElement.classList.add(
              dayData.efficient ? "efficient" : "inefficient"
            );

            const dayInfo = document.createElement("div");
            dayInfo.style.fontSize = "0.7em";
            dayInfo.innerHTML = `${dayData.duration}åˆ†é’Ÿ<br>${dayData.taskCount}ä»»åŠ¡`;
            dayElement.appendChild(dayInfo);
          } else {
            const dayInfo = document.createElement("div");
            dayInfo.style.fontSize = "0.7em";
            dayInfo.innerHTML = `0åˆ†é’Ÿ<br>0ä»»åŠ¡`;
            dayElement.appendChild(dayInfo);
          }

          dayElement.addEventListener("click", () => {
            showDayDetails(dateStr, dayData);
          });

          grid.appendChild(dayElement);
        }

        container.appendChild(grid);

        // Weekly stats chart
        const statsContainer = document.createElement("div");
        statsContainer.className = "stats-container";

        const statsTitle = document.createElement("h4");
        statsTitle.textContent = "æœ€è¿‘14å¤©ç»Ÿè®¡(å­¦ä¹ æ—¶é•¿)";
        statsContainer.appendChild(statsTitle);

        const chart = document.createElement("div");
        chart.className = "stats-chart";

        const last14Days = getLast14Days();
        const maxDuration = Math.max(
          ...last14Days.map((day) => calendarData[day.date]?.duration || 0),
          1
        );

        last14Days.forEach((day) => {
          const dayData = calendarData[day.date];
          const hasData =
            dayData && (dayData.duration > 0 || dayData.taskCount > 0);

          const bar = document.createElement("div");
          bar.className = `chart-bar ${
            hasData
              ? dayData.efficient
                ? "efficient"
                : "inefficient"
              : "inefficient"
          }`;
          bar.style.height = `${
            hasData ? (dayData.duration / maxDuration) * 150 : 5
          }px`;

          const valueLabel = document.createElement("div");
          valueLabel.className = "chart-value";
          valueLabel.textContent = hasData ? dayData.duration : "0";
          bar.appendChild(valueLabel);

          const dateLabel = document.createElement("div");
          dateLabel.className = "chart-label";
          dateLabel.textContent = day.date.split("-").slice(1).join("/");
          bar.appendChild(dateLabel);

          chart.appendChild(bar);
        });

        statsContainer.appendChild(chart);
        container.appendChild(statsContainer);

        // å°†æ—¥å†æ·»åŠ åˆ°emptyPageContainerä¸­
        emptyPageContainer.appendChild(container);
        updateStatus("è‡ªå¾‹æ—¥å†");
      }

      function showDayDetails(dateStr, existingData = null) {
        // è°ƒç”¨showEmptyPageæ¥å‡†å¤‡å®¹å™¨ï¼Œè®¾ç½®æ ‡é¢˜ä¸º"å­¦ä¹ è®°å½•"
        showEmptyPage("å­¦ä¹ è®°å½•");

        // è·å–emptyPageContainerå’ŒemptyPageTitle
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("æ— æ³•æ‰¾åˆ°ç©ºç™½é¡µé¢å®¹å™¨");
          return;
        }

        // æ¸…ç©ºå®¹å™¨ä½†ä¿ç•™æ ‡é¢˜å…ƒç´ 
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild === emptyPageTitle) {
            break;
          }
          emptyPageContainer.removeChild(emptyPageContainer.firstChild);
        }

        const date = new Date(dateStr);

        // åˆ›å»ºä¸»å®¹å™¨å¹¶åº”ç”¨æ ·å¼
        const container = document.createElement("div");
        container.className = "input-container";
        container.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          backdrop-filter: blur(var(--blur-amount));
          border-radius: 15px;
          padding: 2rem;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          max-width: 500px;
          margin: 2rem auto;
        `;

        // åˆ›å»ºæ ‡é¢˜
        const title = document.createElement("h3");
        title.textContent = `å­¦ä¹ è®°å½• - ${date.toLocaleDateString("zh-CN")}`;
        title.style.cssText = `
          color: var(--primary-color);
          margin-bottom: 1.5rem;
          text-align: center;
          font-size: 1.5rem;
        `;
        container.appendChild(title);

        // åˆ›å»ºè¡¨å•æ ·å¼å®¹å™¨
        const formStyle = document.createElement("div");
        formStyle.style.cssText = `
          display: flex;
          flex-direction: column;
          gap: 1rem;
        `;
        container.appendChild(formStyle);

        // ä»»åŠ¡æ•°é‡è¾“å…¥
        const taskCountContainer = document.createElement("div");
        taskCountContainer.style.marginBottom = "1rem";

        const taskCountLabel = document.createElement("label");
        taskCountLabel.textContent = "å®Œæˆä»»åŠ¡æ•°é‡:";
        taskCountLabel.style.display = "block";
        taskCountLabel.style.marginBottom = "0.5rem";
        taskCountLabel.style.fontWeight = "500";

        const taskCountInput = document.createElement("input");
        taskCountInput.type = "number";
        taskCountInput.min = "0";
        taskCountInput.value = existingData?.taskCount || "0";
        taskCountInput.style.cssText = `
          width: 100%;
          padding: 0.8rem;
          border: 1px solid #ddd;
          border-radius: 8px;
          font-size: 1rem;
          outline: none;
          transition: border-color 0.3s ease;
        `;
        taskCountInput.onfocus = function () {
          this.style.borderColor = "var(--primary-color)";
        };
        taskCountInput.onblur = function () {
          this.style.borderColor = "#ddd";
        };

        taskCountContainer.appendChild(taskCountLabel);
        taskCountContainer.appendChild(taskCountInput);
        formStyle.appendChild(taskCountContainer);

        // å­¦ä¹ æ—¶é•¿è¾“å…¥
        const durationContainer = document.createElement("div");
        durationContainer.style.marginBottom = "1rem";

        const durationLabel = document.createElement("label");
        durationLabel.textContent = "å­¦ä¹ æ—¶é•¿ (åˆ†é’Ÿ):";
        durationLabel.style.display = "block";
        durationLabel.style.marginBottom = "0.5rem";
        durationLabel.style.fontWeight = "500";

        const durationInput = document.createElement("input");
        durationInput.type = "number";
        durationInput.min = "0";
        durationInput.value = existingData?.duration || "0";
        durationInput.style.cssText = `
          width: 100%;
          padding: 0.8rem;
          border: 1px solid #ddd;
          border-radius: 8px;
          font-size: 1rem;
          outline: none;
          transition: border-color 0.3s ease;
        `;
        durationInput.onfocus = function () {
          this.style.borderColor = "var(--primary-color)";
        };
        durationInput.onblur = function () {
          this.style.borderColor = "#ddd";
        };

        durationContainer.appendChild(durationLabel);
        durationContainer.appendChild(durationInput);
        formStyle.appendChild(durationContainer);

        // æ•ˆç‡é€‰æ‹©
        const efficientContainer = document.createElement("div");
        efficientContainer.style.cssText = `
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-bottom: 1.5rem;
          padding: 0.8rem;
          background: #f9f9f9;
          border-radius: 8px;
        `;

        const efficientLabel = document.createElement("label");
        efficientLabel.textContent = "ä»Šå¤©çš„å­¦ä¹ æ•ˆç‡é«˜å—?";
        efficientLabel.style.fontWeight = "500";

        const efficientCheckbox = document.createElement("input");
        efficientCheckbox.type = "checkbox";
        efficientCheckbox.checked = existingData?.efficient || false;
        efficientCheckbox.style.width = "20px";
        efficientCheckbox.style.height = "20px";
        efficientCheckbox.style.cursor = "pointer";

        efficientContainer.appendChild(efficientCheckbox);
        efficientContainer.appendChild(efficientLabel);
        formStyle.appendChild(efficientContainer);

        // æŒ‰é’®ç»„
        const buttonGroup = document.createElement("div");
        buttonGroup.className = "button-group";
        buttonGroup.style.cssText = `
          display: flex;
          gap: 1rem;
          justify-content: center;
          margin: 2rem 0;
        `;

        // ä¿å­˜æŒ‰é’®
        const saveButton = document.createElement("button");
        saveButton.textContent = "ä¿å­˜";
        saveButton.style.cssText = `
          padding: 1rem 2rem;
          background: var(--primary-color);
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 1.1rem;
          font-weight: bold;
          transition: all 0.3s ease;
        `;
        saveButton.onmouseover = function () {
          this.style.transform = "scale(1.05)";
          this.style.background = "var(--primary-hover)";
        };
        saveButton.onmouseout = function () {
          this.style.transform = "scale(1)";
        };
        saveButton.addEventListener("click", () => {
          const taskCount = parseInt(taskCountInput.value) || 0;
          const duration = parseInt(durationInput.value) || 0;
          const efficient = efficientCheckbox.checked;

          if (taskCount > 0 || duration > 0) {
            calendarData[dateStr] = {
              taskCount,
              duration,
              efficient,
              timestamp: new Date().toISOString(),
            };
            saveCalendarData();

            // æ˜¾ç¤ºä¿å­˜æˆåŠŸåŠ¨ç”»æ•ˆæœ
            const successMessage = document.createElement("div");
            successMessage.style.cssText = `
              text-align: center;
              padding: 1rem;
              background: #4CAF50;
              color: white;
              border-radius: 8px;
              margin-top: 1rem;
              animation: fadeInOut 2s ease-in-out;
            `;
            successMessage.textContent = "è®°å½•å·²ä¿å­˜ï¼";
            container.appendChild(successMessage);

            updateStatus("è®°å½•å·²ä¿å­˜");

            // å»¶è¿Ÿåè¿”å›æ—¥å†
            setTimeout(() => {
              showLearningCalendar();
            }, 1000);
          } else {
            // Remove entry if both are 0
            if (calendarData[dateStr]) {
              delete calendarData[dateStr];
              saveCalendarData();
            }
            updateStatus("è®°å½•å·²æ¸…é™¤");
            showLearningCalendar();
          }
        });

        // è¿”å›æŒ‰é’®
        const cancelButton = document.createElement("button");
        cancelButton.textContent = "è¿”å›æ—¥å†";
        cancelButton.className = "cancel";
        cancelButton.style.cssText = `
          padding: 1rem 2rem;
          background: #666;
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 1.1rem;
          font-weight: bold;
          transition: all 0.3s ease;
        `;
        cancelButton.onmouseover = function () {
          this.style.transform = "scale(1.05)";
          this.style.background = "#555";
        };
        cancelButton.onmouseout = function () {
          this.style.transform = "scale(1)";
        };
        cancelButton.addEventListener("click", () => {
          showLearningCalendar();
        });

        buttonGroup.appendChild(saveButton);
        buttonGroup.appendChild(cancelButton);
        container.appendChild(buttonGroup);

        // å¦‚æœæœ‰ç°æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºè¯¦æƒ…
        if (existingData) {
          const details = document.createElement("div");
          details.className = "day-details";
          details.style.cssText = `
            text-align: center;
            padding: 1.5rem;
            background: #f5f5f5;
            border-radius: 10px;
            margin-top: 1rem;
          `;
          details.innerHTML = `
            <h4 style="color: var(--primary-color); margin-bottom: 1rem;">å½“å‰è®°å½•</h4>
            <p style="margin: 0.5rem 0; font-size: 1.1rem;">å®Œæˆä»»åŠ¡: <strong>${
              existingData.taskCount
            }</strong></p>
            <p style="margin: 0.5rem 0; font-size: 1.1rem;">å­¦ä¹ æ—¶é•¿: <strong>${
              existingData.duration
            } åˆ†é’Ÿ</strong></p>
            <p style="margin: 0.5rem 0; font-size: 1.1rem;">æ•ˆç‡: <strong style="color: ${
              existingData.efficient ? "#4CAF50" : "#FF5252"
            };">${existingData.efficient ? "âœ… é«˜æ•ˆ" : "âŒ ä½æ•ˆ"}</strong></p>
          `;
          container.appendChild(details);
        }

        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        container.style.opacity = "0";
        container.style.transform = "translateY(20px)";
        container.style.transition = "opacity 0.5s ease, transform 0.5s ease";

        // å°†å®¹å™¨æ·»åŠ åˆ°emptyPageContainerä¸­
        emptyPageContainer.appendChild(container);

        // è§¦å‘åŠ¨ç”»
        setTimeout(() => {
          container.style.opacity = "1";
          container.style.transform = "translateY(0)";
        }, 10);
      }

      function loadCalendarData() {
        const savedData = localStorage.getItem(CALENDAR_DATA_KEY);
        if (savedData) {
          try {
            calendarData = JSON.parse(savedData);
          } catch (e) {
            console.error("åŠ è½½æ—¥å†æ•°æ®é”™è¯¯:", e);
            calendarData = {};
          }
        } else {
          calendarData = {};
        }
      }

      function saveCalendarData() {
        try {
          localStorage.setItem(CALENDAR_DATA_KEY, JSON.stringify(calendarData));
          return true;
        } catch (e) {
          console.error("ä¿å­˜æ—¥å†æ•°æ®é”™è¯¯:", e);
          return false;
        }
      }

      function getLast14Days() {
        const result = [];
        for (let i = 13; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];
          result.push({ date: dateStr });
        }
        return result;
      }

      // æ£€æŸ¥ç½‘ç«™å±è”½çŠ¶æ€
      function checkWebsiteBlockingStatus() {
        const isBlocking =
          localStorage.getItem("websiteBlockingEnabled") === "true";
        const blockMode = localStorage.getItem("blockMode") || "blacklist";
        const blockedSites = localStorage.getItem("blockedSites") || "";
        const whitelistedSites = localStorage.getItem("whitelistedSites") || "";

        // æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œå‰ç«¯JavaScriptæ— æ³•ç›´æ¥æ‹¦æˆªç½‘ç«™è®¿é—®
        // è¿™é‡Œåªæ˜¯æ¨¡æ‹ŸåŠŸèƒ½ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æµè§ˆå™¨æ‰©å±•æˆ–å…¶ä»–æ–¹å¼å®ç°
        if (isBlocking) {
          // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ç½‘ç«™æ‹¦æˆªé€»è¾‘ï¼ˆå¦‚æœåœ¨æµè§ˆå™¨æ‰©å±•ä¸­è¿è¡Œï¼‰
          console.log("ç½‘ç«™å±è”½åŠŸèƒ½å·²å¯ç”¨ï¼Œæ¨¡å¼ï¼š", blockMode);
        }
      }
    </script>
  </body>
</html>
